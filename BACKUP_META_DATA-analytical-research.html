<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è§£æ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- KBC Design CSS Start --- */
        :root { 
            --bg:#0b1220; 
            --card:#071427; 
            --muted:#9fb0c8; 
            --accent:#3b82f6; 
            --glass: rgba(255,255,255,0.03); 
            --text:#e6f0fb; 
        } 
        *{
            box-sizing:border-box;
        } 
        body{ 
            margin:0; 
            font-family:"Noto Sans JP",sans-serif; 
            background:linear-gradient(180deg,#051026 0%,#081428 60%); 
            color:var(--text); 
            padding:20px; 
            display:flex; 
            justify-content:center; 
            animation: fadeIn 1s ease forwards; 
            opacity:0; 
        } 
        @keyframes fadeIn { 
            from { opacity:0; transform: translateY(10px); } 
            to { opacity:1; transform: translateY(0); } 
        } 
        .container{ 
            width:1100px; 
            max-width:100%; 
            display:grid; 
            gap:16px; 
        } 
        .header{ 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            flex-wrap:wrap; 
            padding:10px 0; 
            border-bottom:1px solid rgba(255,255,255,0.1); 
            animation: fadeIn 1s ease 0.2s forwards; 
            opacity:0; 
        } 
        .logo{ 
            display:flex; 
            align-items:center; 
            gap:10px; 
        } 
        .logo img{ 
            width:40px; 
            height:40px; 
            border-radius:8px; 
            box-shadow:0 0 10px rgba(59,130,246,0.4); 
            animation: floatLogo 3s ease-in-out infinite; 
        } 
        @keyframes floatLogo { 
            0%,100% { transform: translateY(0); } 
            50% { transform: translateY(-4px); } 
        } 
        h1{
            margin:0;
            font-size:22px;
        } 
        .nav{ 
            display:flex; 
            gap:20px; 
            flex-wrap:wrap; 
        } 
        .nav a{ 
            color:var(--muted); 
            text-decoration:none; 
            font-size:14px; 
            transition:0.2s; 
        } 
        .nav a:hover{ 
            color:var(--accent); 
        } 
        .hero{ 
            text-align:center; 
            padding:60px 20px; 
            background:var(--card); 
            border-radius:12px; 
            box-shadow:0 8px 30px rgba(2,6,23,0.6); 
            animation: fadeIn 1s ease 0.4s forwards; 
            opacity:0; 
        } 
        .hero h2{ 
            font-size:28px; 
            margin:0 0 10px; 
        } 
        .hero p{ 
            color:var(--muted); 
            font-size:15px; 
            margin:0; 
        } 
        .grid{ 
            display:grid; 
            grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); 
            gap:16px; 
        } 
        .card{ 
            background:var(--card); 
            border-radius:12px; 
            padding:20px; 
            box-shadow:0 8px 30px rgba(2,6,23,0.6); 
            transition:transform 0.3s, box-shadow 0.3s; 
            opacity:0; 
            animation: fadeIn 1s ease forwards; 
        } 
        .card:nth-child(1){animation-delay:0.6s;} 
        .card:nth-child(2){animation-delay:0.8s;} 
        .card:nth-child(3){animation-delay:1s;} 
        .card:nth-child(4){animation-delay:1.2s;} 
        .card:nth-child(5){animation-delay:1.4s;} 
        .card:hover{ 
            transform:translateY(-6px); 
            box-shadow:0 10px 40px rgba(59,130,246,0.3); 
        } 
        .card h3{ 
            margin-top:0; 
            font-size:18px; 
            color:var(--accent); 
        } 
        .card p{ 
            font-size:14px; 
            color:var(--muted); 
        } 
        footer{ 
            text-align:center; 
            color:var(--muted); 
            font-size:13px; 
            margin-top:30px; 
            border-top:1px solid rgba(255,255,255,0.05); 
            padding-top:10px; 
            animation: fadeIn 1s ease 1.2s forwards; 
            opacity:0; 
        } 
        /* --- KBC Design CSS End --- */

        /* --- Custom Styles for Analyzer --- */
        
        /* å…±é€šã®è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ */
        .card h2 {
            font-size: 20px;
            color: var(--accent);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ— */
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        input[type="file"] {
            padding: 10px;
            border: 1px solid var(--glass);
            border-radius: 8px;
            flex-grow: 1;
            background-color: var(--glass);
            color: var(--text);
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background-color: var(--accent);
            color: var(--text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #5b9bf9;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }
        th {
            background-color: var(--accent);
            color: var(--bg);
            font-weight: bold;
            border: 1px solid var(--accent);
        }
        tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* ãƒ©ãƒ³ã‚¯ã¨æ™‚é–“ã®ä¸¦åˆ—è¡¨ç¤º */
        .summary-block {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 15px;
        }
        .summary-item {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: var(--muted);
        }
        .summary-item strong {
            display: block;
            font-size: 24px;
            color: var(--text);
            text-shadow: 0 0 5px var(--accent);
        }
        .summary-item .sub-text {
            font-size: 11px;
            color: var(--muted);
            margin-top: 5px;
            display: block;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    
    <header class="header">
        <div class="logo">
            <img src="logo.png" alt="Logo Placeholder">
            <h1>KBC</h1>
        </div>
        <nav class="nav">
            <a href="#">ãƒ›ãƒ¼ãƒ </a>
            <a href="#">ä»®</a>
            <a href="#">ä»®</a>
        </nav>
    </header>
    <section class="hero" style="text-align: left; padding: 30px;">
        <h2>ğŸ“Šãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è§£æãƒ„ãƒ¼ãƒ«</h2>
        <p>BACKUP_META_DATAã‚’é¸æŠã—ã€ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒè‡ªå‹•çš„ã«è§£æã•ã‚Œã€ã‚¢ã‚¤ãƒ†ãƒ ã®åˆ©ç”¨çŠ¶æ³ã¨ãƒ—ãƒ¬ã‚¤æ™‚é–“ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        
        <div class="input-group">
            <input type="file" id="jsonFile" accept="*/*" title="æ‹¡å¼µå­ã®ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚é¸æŠå¯èƒ½ã§ã™">
            <button id="readFileButton">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
        </div>
        
        <div id="results">
            </div>
    </section>
    <footer>
        <p>ä½•è¦‹ã¦ã‚“ã ã‚ˆ</p>
    </footer>

</div>

<script>
    // ãƒ—ãƒ¬ã‚¤ã‚¿ã‚¤ãƒ ã®æ›ç®—ãƒ¬ãƒ¼ãƒˆ (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š: 1ç§’ã§30å¢—åŠ )
    const PLAYTIME_RATE = 30;

    // HTMLè¦ç´ ã®å–å¾—
    const fileInput = document.getElementById('jsonFile');
    const readFileButton = document.getElementById('readFileButton');
    const resultsDiv = document.getElementById('results');

    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    readFileButton.addEventListener('click', handleFileRead);

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€è§£æã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
     */
    function handleFileRead() {
        const file = fileInput.files[0];
        if (!file) {
            resultsDiv.innerHTML = '<p class="error">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>';
            return;
        }

        // èª­ã¿è¾¼ã¿ä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        resultsDiv.innerHTML = `<p style="color:var(--accent);">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­... (${file.name})</p>`;
        
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const jsonText = e.target.result;
                const data = JSON.parse(jsonText);
                
                const summary = analyzeData(data);
                displayResults(summary, data);

            } catch (error) {
                // JSONè§£æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                resultsDiv.innerHTML = `<p class="error">ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ‰åŠ¹ãªJSONå½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}</p>`;
                console.error("Parsing error:", error);
            }
        };

        reader.readAsText(file);
    }

    /**
     * JSONãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ã‚¢ã‚¤ãƒ†ãƒ ã®é›†è¨ˆã‚’è¡Œã†
     */
    function analyzeData(data) {
        let itemSummary = {}; 

        if (data.managedItemDetails && Array.isArray(data.managedItemDetails)) {
            data.managedItemDetails.forEach(detail => {
                const type = detail.managedItemType;
                const amount = detail.amount || 0; 
                const action = detail.detailType; 

                if (!itemSummary[type]) {
                    itemSummary[type] = { get: 0, use: 0, net: 0 };
                }

                if (action === 'get') {
                    itemSummary[type].get += amount;
                } else if (action === 'use') {
                    itemSummary[type].use += amount;
                }
            });
        }
        
        for (const type in itemSummary) {
            itemSummary[type].net = itemSummary[type].get - itemSummary[type].use;
        }

        return itemSummary;
    }

    /**
     * ç§’ã‚’ã€Œæ™‚é–“ã€åˆ†ã€ç§’ã€ã®å½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (æ—¥ã‚’é™¤ã)
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã«ã‚ˆã‚Šã€æœ€å¤§å˜ä½ã¯ã€Œæ™‚é–“ã€ã¨ã™ã‚‹
     * @param {number} totalSeconds - åˆè¨ˆç§’æ•°
     * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ™‚é–“æ–‡å­—åˆ—
     */
    function formatTimeHours(totalSeconds) {
        // ç§’ã‚’å››æ¨äº”å…¥ã—ã¦æ•´æ•°ã«ã™ã‚‹
        totalSeconds = Math.round(totalSeconds);

        const hours = Math.floor(totalSeconds / 3600);
        totalSeconds %= 3600;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        let parts = [];
        if (hours > 0) parts.push(`${hours.toLocaleString()}æ™‚é–“`);
        // æ™‚é–“ãŒ0ã§ã‚‚åˆ†ãŒ0ã§ãªã‘ã‚Œã°è¡¨ç¤ºã€ã¾ãŸã¯æ™‚é–“ãŒ1ä»¥ä¸Šãªã‚‰åˆ†ã‚’è¡¨ç¤º
        if (minutes > 0 || hours > 0) parts.push(`${minutes}åˆ†`); 
        parts.push(`${seconds}ç§’`); // ç§’ã¯å¸¸ã«è¡¨ç¤º

        return parts.join('');
    }

    /**
     * è§£æçµæœã‚’HTMLã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    function displayResults(summary, data) {
        let html = '';

        // 1. ãƒ—ãƒ¬ã‚¤æ™‚é–“ã¨ãƒ©ãƒ³ã‚¯ã®ã‚µãƒãƒªãƒ¼
        html += '<h3 style="color:var(--muted); margin-top:20px; border-bottom:1px solid var(--glass); padding-bottom:10px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>';

        let rankHtml = `
            <div class="summary-item">
                <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚¯</h4>
                <strong>${data.rank !== undefined ? data.rank.toLocaleString() : 'N/A'}</strong>
                <span class="sub-text">${data.rank !== undefined ? 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'ãƒ©ãƒ³ã‚¯æƒ…å ±ãªã—'}</span>
            </div>
        `;

        let timeHtml = `
            <div class="summary-item">
                <h4>ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“ (${PLAYTIME_RATE}å€æ›ç®—)</h4>
                <strong>${data.playTime !== undefined ? formatTimeHours(data.playTime / PLAYTIME_RATE) : 'N/A'}</strong>
                <span class="sub-text">${data.playTime !== undefined ? `ç”Ÿãƒ‡ãƒ¼ã‚¿: ${data.playTime.toLocaleString()}` : 'ãƒ—ãƒ¬ã‚¤ã‚¿ã‚¤ãƒ æƒ…å ±ãªã—'}</span>
            </div>
        `;

        // ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“ã¨ãƒ©ãƒ³ã‚¯ã‚’ä¸¦ã¹ã¦è¡¨ç¤ºã™ã‚‹
        html += `<div class="summary-block">${timeHtml}${rankHtml}</div>`;


        // 2. ã‚¢ã‚¤ãƒ†ãƒ é›†è¨ˆçµæœã®è¡¨ç¤º
        html += '<h3 style="color:var(--muted); margin-top:30px; border-bottom:1px solid var(--glass); padding-bottom:10px;">ã‚¢ã‚¤ãƒ†ãƒ åˆ¥ å–å¾—é‡/ä½¿ç”¨é‡</h3>';
        
        const itemTypes = Object.keys(summary).sort();
        if (itemTypes.length > 0) {
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>ã‚¢ã‚¤ãƒ†ãƒ å</th>
                            <th>åˆè¨ˆå–å¾—é‡ (GET)</th>
                            <th>åˆè¨ˆä½¿ç”¨é‡ (USE)</th>
                            <th>ç´”å¢—æ¸›é‡ (GET - USE)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            itemTypes.forEach(type => {
                const item = summary[type];
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${item.get.toLocaleString()}</td>
                        <td>${item.use.toLocaleString()}</td>
                        <td style="color: ${item.net >= 0 ? 'var(--accent)' : '#ff6b6b'}; font-weight: bold;">${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
        } else {
            html += '<p class="card" style="margin-top:20px; animation-delay:0s;">ã‚¢ã‚¤ãƒ†ãƒ ã®å–å¾—/ä½¿ç”¨å±¥æ­´ (managedItemDetails) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        }

        // 3. ãã®ä»–ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆç½²åï¼‰
        if (data.signature_v1 !== undefined) {
            html += '<h3 style="color:var(--muted); margin-top:30px; border-bottom:1px solid var(--glass); padding-bottom:10px;">ãã®ä»–æƒ…å ±</h3>';
            html += `<p style="font-size:12px; color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ã®ç½²å (signature_v1): <span style="word-break: break-all; color: var(--text);">${data.signature_v1}</span></p>`;
        }
        
        resultsDiv.innerHTML = html;
    }
</script>

</body>
</html>

