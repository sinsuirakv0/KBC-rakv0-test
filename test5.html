<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã«ã‚ƒã‚“ã“å¤§æˆ¦äº‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬ ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange: #ff8c00;
      --orange-light: #ffa733;
      --orange-dark: #cc6f00;
      --bg: #f7f3ee;
      --card-bg: #ffffff;
      --text: #2a2a2a;
      --text-muted: #888;
      --border: #e5ddd5;
      --green: #4caf50;
      --blue: #2196f3;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    header {
      background: var(--orange);
      color: white;
      padding: 12px 16px;
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header .cat-icon { font-size: 1.4rem; }

    /* ===== ã‚¿ãƒ– ===== */
    .tabs {
      display: flex;
      background: #fff;
      border-bottom: 3px solid var(--orange);
      overflow-x: auto;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      white-space: nowrap;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      margin-bottom: -3px;
      transition: color 0.2s, border-color 0.2s;
    }
    .tab:hover { color: var(--orange); }
    .tab.active {
      color: var(--orange);
      border-bottom-color: var(--orange);
    }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
    .controls {
      background: #fff;
      padding: 10px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.88rem;
      cursor: pointer;
      color: var(--text);
    }
    .controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--orange);
      cursor: pointer;
    }
    #now-display {
      margin-left: auto;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== */
    main { max-width: 800px; margin: 0 auto; padding: 12px 12px 40px; }

    .content { display: none; }
    .content.active { display: block; }

    /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }
    .loading::before { content: 'ğŸ± '; }

    /* ===== ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ ===== */
    .event-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 8px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--orange-light);
      transition: box-shadow 0.2s;
    }
    .event-card:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.12); }
    .event-card.is-current { border-left-color: var(--green); }

    .card-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .event-name {
      font-weight: bold;
      font-size: 0.93rem;
      line-height: 1.5;
      flex: 1;
      min-width: 0;
    }

    .event-message {
      color: #555;
      font-size: 0.82rem;
      margin-top: 5px;
      line-height: 1.5;
    }

    .event-dates {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* ===== ã‚¿ã‚° ===== */
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 99px;
      font-size: 0.72rem;
      font-weight: bold;
      white-space: nowrap;
    }
    .tag-current { background: var(--green); color: white; }
    .tag-future  { background: var(--blue); color: white; }

    /* ===== ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º ===== */
    .count-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-left: 2px;
    }

    /* ===== ç©ºçŠ¶æ…‹ ===== */
    .empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* ===== ã‚«ãƒ¼ãƒ‰: æ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    .event-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 11px 14px;
      margin-bottom: 7px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--orange-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: box-shadow 0.2s, background 0.15s;
      user-select: none;
    }
    .event-card:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.13); background: #fdf8f2; }
    .event-card.is-current { border-left-color: var(--green); }

    .card-tag {
      flex-shrink: 0;
      display: inline-block;
      padding: 2px 7px;
      border-radius: 99px;
      font-size: 0.7rem;
      font-weight: bold;
      white-space: nowrap;
    }
    .tag-current { background: var(--green); color: white; }
    .tag-future  { background: var(--blue);  color: white; }
    .tag-past    { background: #aaa;          color: white; }

    .card-body { flex: 1; min-width: 0; }
    .card-period {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .card-name {
      font-weight: bold;
      font-size: 0.9rem;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .card-arrow { flex-shrink: 0; color: #ccc; font-size: 0.8rem; }

    /* ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
    .overlay-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 200;
      justify-content: center;
      align-items: flex-end;
    }
    .overlay-backdrop.show { display: flex; }
    .overlay-panel {
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 20px 20px 32px;
      width: 100%;
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp 0.25s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .overlay-close {
      float: right; font-size: 1.4rem; cursor: pointer;
      color: #aaa; line-height: 1; padding: 0 4px;
    }
    .overlay-close:hover { color: #444; }
    .overlay-title {
      font-size: 1rem; font-weight: bold;
      margin-bottom: 14px; line-height: 1.5; padding-right: 24px;
    }
    .overlay-section { margin-bottom: 12px; }
    .overlay-label {
      font-size: 0.75rem; font-weight: bold;
      color: var(--orange-dark); margin-bottom: 3px;
    }
    .overlay-value {
      font-size: 0.88rem; color: var(--text);
      line-height: 1.7; white-space: pre-wrap;
    }
    .overlay-divider { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
    .count-label {
      font-size: 0.8rem; color: var(--text-muted);
      margin-bottom: 8px; padding-left: 2px;
    }
    .empty {
      text-align: center; padding: 40px;
      color: var(--text-muted); font-size: 0.9rem;
    }
    .loading {
      text-align: center; padding: 40px;
      color: var(--text-muted); font-size: 0.95rem;
    }
    .loading::before { content: 'ğŸ± '; }
  </style>
</head>
<body>

<header>
  <span class="cat-icon">ğŸ±</span>
  ã«ã‚ƒã‚“ã“å¤§æˆ¦äº‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
</header>

<div class="tabs">
  <div class="tab active" data-tab="gatya">ã‚¬ãƒãƒ£</div>
  <div class="tab" data-tab="sale">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
  <div class="tab" data-tab="item">ã‚¢ã‚¤ãƒ†ãƒ </div>
  <div class="tab" data-tab="mission">ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
</div>

<div class="controls">
  <label>
    <input type="checkbox" id="showCurrent">
    é–‹å‚¬ä¸­ã‚‚è¡¨ç¤º
  </label>
  <label>
    <input type="checkbox" id="showPast">
    éå»ã‚‚è¡¨ç¤º
  </label>
  <label>
    <input type="checkbox" id="sortByDate">
    æ—¥ä»˜é †ã«ä¸¦ã¹ã‚‹
  </label>
  <span id="now-display"></span>
</div>

<main>
  <div id="gatya"   class="content active"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="sale"    class="content"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="item"    class="content"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="mission" class="content"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
</main>

<!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="overlay" class="overlay-backdrop">
  <div class="overlay-panel">
    <span class="overlay-close" id="overlay-close">&times;</span>
    <div class="overlay-title" id="overlay-title"></div>
    <hr class="overlay-divider">
    <div id="overlay-body"></div>
  </div>
</div>

<script>
// =============================================
// çŠ¶æ…‹ç®¡ç†
// =============================================
let gatyaData = [];
let saleData  = [];
let itemData  = [];
let saleNames = new Map(); // stageId -> åå‰

// =============================================
// å®šæ•°
// =============================================
const WEEKDAY_JP = { Mon:'æœˆ', Tue:'ç«', Wed:'æ°´', Thu:'æœ¨', Fri:'é‡‘', Sat:'åœŸ', Sun:'æ—¥' };
const DOW_JP     = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

// =============================================
// ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¤å®š
// å¯¾è±¡: 8000å°, 9000å°, 15000å°, 17000å°
// =============================================
function isMissionId(id) {
  return (id >= 8000  && id <= 8999)  ||
         (id >= 9000  && id <= 9999)  ||
         (id >= 15000 && id <= 15999) ||
         (id >= 17000 && id <= 17999);
}

// =============================================
// æ™‚åˆ»æ–‡å­—åˆ—ãƒ‘ãƒ¼ã‚¹
// "800" â†’ "08:00", "1100" â†’ "11:00", "0" â†’ "00:00"
// =============================================
function parseTimeStr(t) {
  const s = String(t).padStart(4, '0');
  return `${s.slice(0,2)}:${s.slice(2,4)}`;
}

// 00:00ã‹ã©ã†ã‹ï¼ˆè¡¨ç¤ºçœç•¥åˆ¤å®šï¼‰
function isMidnight(t) {
  const s = String(t).padStart(4, '0');
  return s === '0000';
}

// =============================================
// ãƒ˜ãƒƒãƒ€ãƒ¼æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ â†’ Date
// dateStr: "20260216", timeStr: "1100"
// =============================================
function parseDateTime(dateStr, timeStr) {
  const y   = parseInt(dateStr.slice(0, 4));
  const mon = parseInt(dateStr.slice(4, 6)) - 1;
  const d   = parseInt(dateStr.slice(6, 8));
  const s   = String(timeStr).padStart(4, '0');
  return new Date(y, mon, d, parseInt(s.slice(0,2)), parseInt(s.slice(2,4)));
}

// =============================================
// ã‚«ãƒ¼ãƒ‰ç”¨æœŸé–“æ–‡å­—åˆ—
// ä¾‹: "02/16ã€œ03/03"  "02/16(11:00)ã€œ03/03"
// 00:00ã¯çœç•¥
// =============================================
function formatCardPeriod(dateStr, timeStr, eDateStr, eTimeStr) {
  const sm = dateStr.slice(4,6);
  const sd = dateStr.slice(6,8);
  const em = eDateStr.slice(4,6);
  const ed = eDateStr.slice(6,8);
  const st = isMidnight(timeStr)  ? '' : `(${parseTimeStr(timeStr)})`;
  const et = isMidnight(eTimeStr) ? '' : `(${parseTimeStr(eTimeStr)})`;
  return `${sm}/${sd}${st}ã€œ${em}/${ed}${et}`;
}

// =============================================
// è©³ç´°ç”¨æ—¥ä»˜æ–‡å­—åˆ—ï¼ˆæ›œæ—¥ä»˜ãï¼‰
// ä¾‹: "2026/02/16(æœˆ) 11:00"
// =============================================
function formatDetailDate(dateStr, timeStr) {
  const dt  = parseDateTime(dateStr, timeStr);
  const y   = dt.getFullYear();
  const mon = String(dt.getMonth()+1).padStart(2,'0');
  const d   = String(dt.getDate()).padStart(2,'0');
  const dow = DOW_JP[dt.getDay()];
  const t   = parseTimeStr(timeStr);
  return `${y}/${mon}/${d}(${dow}) ${t}`;
}

// =============================================
// dateRanges ã®æ–‡å­—åˆ—ãƒ‘ãƒ¼ã‚¹
// "223 0" â†’ 2æœˆ23æ—¥ 00:00
// "1023 1100" â†’ 10æœˆ23æ—¥ 11:00
// =============================================
function parseDateRangePart(str) {
  const [datePart, timePart = '0'] = str.trim().split(' ');
  let month, day;
  if (datePart.length <= 3) {
    // 3æ¡: å…ˆé ­1æ¡=æœˆ, æ®‹2æ¡=æ—¥
    month = parseInt(datePart[0]);
    day   = parseInt(datePart.slice(1));
  } else {
    // 4æ¡: å…ˆé ­2æ¡=æœˆ, æ®‹2æ¡=æ—¥
    month = parseInt(datePart.slice(0,2));
    day   = parseInt(datePart.slice(2));
  }
  const timeStr = parseTimeStr(timePart);
  const midnight = isMidnight(timePart);
  return { month, day, timeStr, midnight };
}

// =============================================
// timeRanges â†’ "08:00~10:00 & 12:00~14:00"
// =============================================
function formatTimeRanges(ranges) {
  return ranges.map(([s, e]) => `${parseTimeStr(s)}~${parseTimeStr(e)}`).join(' & ');
}

// =============================================
// æ›œæ—¥é…åˆ— â†’ "æœˆãƒ»æ°´ãƒ»é‡‘"
// =============================================
function formatWeekdays(days) {
  return days.map(d => WEEKDAY_JP[d] || d).join('ãƒ»');
}

// =============================================
// 1ã¤ã® timeBlock ã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢ã«å¤‰æ›
// æˆ»ã‚Šå€¤: æ–‡å­—åˆ—ï¼ˆè¤‡æ•°è¡Œã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
// =============================================
function formatTimeBlock(block) {
  const { dateRanges, monthDays, weekdays, timeRanges } = block;
  const timeStr = formatTimeRanges(timeRanges);
  const lines   = [];

  // dateRanges: ç‰¹å®šæœŸé–“
  if (dateRanges && dateRanges.length > 0) {
    for (const dr of dateRanges) {
      const s = parseDateRangePart(dr.start);
      const e = parseDateRangePart(dr.end);
      const sStr = `${s.month}/${String(s.day).padStart(2,'0')}${s.midnight ? '' : ' ' + s.timeStr}`;
      const eStr = `${e.month}/${String(e.day).padStart(2,'0')}${e.midnight ? '' : ' ' + e.timeStr}`;
      lines.push(`${sStr}~${eStr} ${timeStr}`);
    }
  }

  // monthDays: æ¯æœˆã€‡æ—¥
  if (monthDays && monthDays.length > 0) {
    lines.push(`${monthDays.join(',')}æ—¥ ${timeStr}`);
  }

  // weekdays: æ›œæ—¥
  if (weekdays && weekdays.length > 0) {
    lines.push(`${formatWeekdays(weekdays)} ${timeStr}`);
  }

  return lines.join('\n');
}

// =============================================
// å…¨ timeBlocks â†’ é–‹å‚¬æœŸé–“ãƒ†ã‚­ã‚¹ãƒˆ
// =============================================
function formatTimeBlocks(blocks) {
  if (!blocks || blocks.length === 0) return 'ï¼ˆå¸¸æ™‚é–‹å‚¬ï¼‰';
  return blocks.map(formatTimeBlock).filter(Boolean).join('\n');
}

// =============================================
// CSV ãƒ‘ãƒ¼ã‚¹: id,åå‰
// =============================================
function parseCSV(text) {
  const map = new Map();
  for (const line of text.split('\n')) {
    const idx = line.indexOf(',');
    if (idx === -1) continue;
    const id   = parseInt(line.slice(0, idx).trim());
    const name = line.slice(idx + 1).trim();
    if (!isNaN(id) && name) map.set(id, name);
  }
  return map;
}

// =============================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° & ã‚½ãƒ¼ãƒˆ
// =============================================
function filterAndSort(events) {
  const now         = new Date();
  const showCurrent = document.getElementById('showCurrent').checked;
  const showPast    = document.getElementById('showPast').checked;
  const sortByDate  = document.getElementById('sortByDate').checked;

  const filtered = events.filter(e => {
    const isPast    = e.end   <= now;
    const isCurrent = e.start <= now && e.end > now;
    const isFuture  = e.start >  now;

    if (showPast)  return true;
    if (isPast)    return false;
    if (isCurrent) return showCurrent;
    if (isFuture)  return true;
    return false;
  });

  if (sortByDate) filtered.sort((a, b) => a.start - b.start);
  return filtered;
}

// =============================================
// ã‚«ãƒ¼ãƒ‰ HTML ç”Ÿæˆï¼ˆæ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
// ã‚¯ãƒªãƒƒã‚¯ã§ openOverlay(detail) ã‚’å‘¼ã¶
// =============================================
function makeCard(period, name, isCurrent, isPast, detail) {
  const tagClass = isPast ? 'tag-past' : isCurrent ? 'tag-current' : 'tag-future';
  const tagLabel = isPast ? 'çµ‚äº†'     : isCurrent ? 'é–‹å‚¬ä¸­'     : 'äºˆå®š';
  const dataAttr = encodeURIComponent(JSON.stringify(detail));
  return `
    <div class="event-card ${isCurrent ? 'is-current' : ''}"
         onclick="openOverlay(decodeURIComponent('${dataAttr}'))">
      <span class="card-tag ${tagClass}">${tagLabel}</span>
      <div class="card-body">
        <div class="card-period">${period}</div>
        <div class="card-name">${name}</div>
      </div>
      <span class="card-arrow">â€º</span>
    </div>`;
}

// =============================================
// sale/mission ã‚¨ãƒ³ãƒˆãƒª â†’ ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—ã«å±•é–‹
// stageIds ã‚’1ã¤ãšã¤åˆ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åˆ†å‰²
// missionOnly: true=ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ã¿, false=ãƒŸãƒƒã‚·ãƒ§ãƒ³é™¤å¤–
// =============================================
function expandSaleEntry(entry, missionOnly) {
  const now    = new Date();
  const result = [];
  for (const id of (entry.stageIds || [])) {
    const isMission = isMissionId(id);
    if (missionOnly !== isMission) continue;

    const start   = parseDateTime(entry.header.startDate, entry.header.startTime);
    const end     = parseDateTime(entry.header.endDate,   entry.header.endTime);
    const name    = saleNames.get(id) ?? `ID:${id}`;
    const period  = formatCardPeriod(
      entry.header.startDate, entry.header.startTime,
      entry.header.endDate,   entry.header.endTime
    );
    // è©³ç´°ãƒ‡ãƒ¼ã‚¿
    const detail = {
      name,
      id,
      period: `${formatDetailDate(entry.header.startDate, entry.header.startTime)} ~ ${formatDetailDate(entry.header.endDate, entry.header.endTime)}`,
      ver:    `${entry.header.minVersion}~${entry.header.maxVersion}`,
      schedule: formatTimeBlocks(entry.timeBlocks),
    };
    result.push({ start, end, name, period, detail });
  }
  return result;
}

// =============================================
// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ é–‹ã
// =============================================
function openOverlay(jsonStr) {
  const d   = JSON.parse(jsonStr);
  const el  = document.getElementById('overlay');
  document.getElementById('overlay-title').textContent = `${d.name}ã€€ID: ${d.id}`;
  document.getElementById('overlay-body').innerHTML = `
    <div class="overlay-section">
      <div class="overlay-label">æœŸé–“</div>
      <div class="overlay-value">${d.period}</div>
    </div>
    <div class="overlay-section">
      <div class="overlay-label">ver</div>
      <div class="overlay-value">${d.ver}</div>
    </div>
    <div class="overlay-section">
      <div class="overlay-label">é–‹å‚¬æœŸé–“</div>
      <div class="overlay-value">${d.schedule}</div>
    </div>`;
  el.classList.add('show');
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

// =============================================
// æ±ç”¨: ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—ã‹ã‚‰ã‚«ãƒ¼ãƒ‰HTMLç”Ÿæˆ
// =============================================
function buildCards(events) {
  const now = new Date();
  return events.map(e => {
    const isCurrent = e.start <= now && e.end > now;
    const isPast    = e.end   <= now;
    return makeCard(e.period, e.name, isCurrent, isPast, e.detail);
  }).join('');
}

// =============================================
// ã‚¬ãƒãƒ£ã‚¿ãƒ–æç”»
// =============================================
function renderGatya() {
  const now  = new Date();
  const cont = document.getElementById('gatya');

  const events = gatyaData.map(entry => {
    const start  = parseDateTime(entry.header.startDate, entry.header.startTime);
    const end    = parseDateTime(entry.header.endDate,   entry.header.endTime);
    const period = formatCardPeriod(
      entry.header.startDate, entry.header.startTime,
      entry.header.endDate,   entry.header.endTime
    );
    const names = (entry.gachas || []).map(g => g.message || '').filter(Boolean);
    const name  = names.length > 0 ? names.join(' / ') : `ã‚¬ãƒãƒ£ ID:${(entry.gachas||[]).map(g=>g.id).join(',')}`;
    const detail = {
      name,
      id: (entry.gachas||[]).map(g=>g.id).join(','),
      period: `${formatDetailDate(entry.header.startDate, entry.header.startTime)} ~ ${formatDetailDate(entry.header.endDate, entry.header.endTime)}`,
      ver: `${entry.header.minVersion}~${entry.header.maxVersion}`,
      schedule: formatTimeBlocks(entry.timeBlocks),
    };
    return { start, end, name, period, detail };
  });

  const filtered = filterAndSort(events);
  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ã‚¬ãƒãƒ£ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>'; return;
  }
  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + buildCards(filtered);
}

// =============================================
// ã‚»ãƒ¼ãƒ«ã‚¿ãƒ–æç”»ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³é™¤å¤–ï¼‰
// =============================================
function renderSale() {
  const cont   = document.getElementById('sale');
  const events = saleData.flatMap(entry => expandSaleEntry(entry, false));
  const filtered = filterAndSort(events);
  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>'; return;
  }
  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + buildCards(filtered);
}

// =============================================
// ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ãƒ–æç”»
// =============================================
function renderItem() {
  const cont = document.getElementById('item');

  const events = itemData.map(entry => {
    const start  = parseDateTime(entry.header.startDate, entry.header.startTime);
    const end    = parseDateTime(entry.header.endDate,   entry.header.endTime);
    const period = formatCardPeriod(
      entry.header.startDate, entry.header.startTime,
      entry.header.endDate,   entry.header.endTime
    );
    const gift   = entry.gift || {};
    const name   = gift.title || `ã‚¤ãƒ™ãƒ³ãƒˆID: ${gift.eventId}`;
    const detail = {
      name,
      id: gift.eventId ?? '-',
      period: `${formatDetailDate(entry.header.startDate, entry.header.startTime)} ~ ${formatDetailDate(entry.header.endDate, entry.header.endTime)}`,
      ver: `${entry.header.minVersion}~${entry.header.maxVersion}`,
      schedule: formatTimeBlocks(entry.timeBlocks),
    };
    return { start, end, name, period, detail };
  });

  const filtered = filterAndSort(events);
  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>'; return;
  }
  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + buildCards(filtered);
}

// =============================================
// ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ãƒ–æç”»ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
// =============================================
function renderMission() {
  const cont   = document.getElementById('mission');
  const events = saleData.flatMap(entry => expandSaleEntry(entry, true));
  const filtered = filterAndSort(events);
  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return;
  }
  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + buildCards(filtered);
}

// =============================================
// å…¨ã‚¿ãƒ–å†æç”»
// =============================================
function renderAll() {
  renderGatya();
  renderSale();
  renderItem();
  renderMission();
}

// =============================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// =============================================
function showTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tabName);
  });
  document.querySelectorAll('.content').forEach(c => {
    c.classList.toggle('active', c.id === tabName);
  });
}

// =============================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// =============================================
async function loadData() {
  try {
    const BASE = 'https://kbc-rakv0.vercel.app/data';
    const [gatyaRes, saleRes, itemRes, saleNameRes] = await Promise.all([
      fetch(`${BASE}/gatya.json`),
      fetch(`${BASE}/sale.json`),
      fetch(`${BASE}/item.json`),
      fetch(`${BASE}/sale_name.csv`),
    ]);

    gatyaData = await gatyaRes.json();
    saleData  = await saleRes.json();
    itemData  = await itemRes.json();

    const saleNameText = await saleNameRes.text();
    saleNames = parseCSV(saleNameText);

    renderAll();
  } catch (err) {
    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    document.querySelectorAll('.loading').forEach(el => {
      el.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
    });
  }
}

// =============================================
// ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
// =============================================
function formatDate(date) {
  const y   = date.getFullYear();
  const mon = String(date.getMonth()+1).padStart(2,'0');
  const d   = String(date.getDate()).padStart(2,'0');
  const h   = String(date.getHours()).padStart(2,'0');
  const min = String(date.getMinutes()).padStart(2,'0');
  return `${y}/${mon}/${d} ${h}:${min}`;
}
function updateNow() {
  document.getElementById('now-display').textContent = 'ç¾åœ¨: ' + formatDate(new Date());
}

// =============================================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
// =============================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => showTab(tab.dataset.tab));
});
['showCurrent', 'showPast', 'sortByDate'].forEach(id => {
  document.getElementById(id).addEventListener('change', renderAll);
});
document.getElementById('overlay-close').addEventListener('click', closeOverlay);
document.getElementById('overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeOverlay();
});

// åˆæœŸåŒ–
updateNow();
setInterval(updateNow, 60000);
loadData();
</script>
</body>
</html>
