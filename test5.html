<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã«ã‚ƒã‚“ã“å¤§æˆ¦äº‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬ ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange: #ff8c00;
      --orange-light: #ffa733;
      --orange-dark: #cc6f00;
      --bg: #f7f3ee;
      --card-bg: #ffffff;
      --text: #2a2a2a;
      --text-muted: #888;
      --border: #e5ddd5;
      --green: #4caf50;
      --blue: #2196f3;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    header {
      background: var(--orange);
      color: white;
      padding: 12px 16px;
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header .cat-icon { font-size: 1.4rem; }

    /* ===== ã‚¿ãƒ– ===== */
    .tabs {
      display: flex;
      background: #fff;
      border-bottom: 3px solid var(--orange);
      overflow-x: auto;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      white-space: nowrap;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      margin-bottom: -3px;
      transition: color 0.2s, border-color 0.2s;
    }
    .tab:hover { color: var(--orange); }
    .tab.active {
      color: var(--orange);
      border-bottom-color: var(--orange);
    }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
    .controls {
      background: #fff;
      padding: 10px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.88rem;
      cursor: pointer;
      color: var(--text);
    }
    .controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--orange);
      cursor: pointer;
    }
    #now-display {
      margin-left: auto;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== */
    main { max-width: 800px; margin: 0 auto; padding: 12px 12px 40px; }

    .content { display: none; }
    .content.active { display: block; }

    /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }
    .loading::before { content: 'ğŸ± '; }

    /* ===== ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ ===== */
    .event-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 8px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--orange-light);
      transition: box-shadow 0.2s;
    }
    .event-card:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.12); }
    .event-card.is-current { border-left-color: var(--green); }

    .card-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .event-name {
      font-weight: bold;
      font-size: 0.93rem;
      line-height: 1.5;
      flex: 1;
      min-width: 0;
    }

    .event-message {
      color: #555;
      font-size: 0.82rem;
      margin-top: 5px;
      line-height: 1.5;
    }

    .event-dates {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* ===== ã‚¿ã‚° ===== */
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 99px;
      font-size: 0.72rem;
      font-weight: bold;
      white-space: nowrap;
    }
    .tag-current { background: var(--green); color: white; }
    .tag-future  { background: var(--blue); color: white; }

    /* ===== ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º ===== */
    .count-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-left: 2px;
    }

    /* ===== ç©ºçŠ¶æ…‹ ===== */
    .empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* ===== ã‚¬ãƒãƒ£ã‚«ãƒ¼ãƒ‰ç‰¹æœ‰ ===== */
    .gatya-rates {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>

<header>
  <span class="cat-icon">ğŸ±</span>
  ã«ã‚ƒã‚“ã“å¤§æˆ¦äº‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
</header>

<div class="tabs">
  <div class="tab active" data-tab="gatya">ã‚¬ãƒãƒ£</div>
  <div class="tab" data-tab="sale">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
  <div class="tab" data-tab="item">ã‚¢ã‚¤ãƒ†ãƒ </div>
  <div class="tab" data-tab="mission">ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
</div>

<div class="controls">
  <label>
    <input type="checkbox" id="showCurrent">
    é–‹å‚¬ä¸­ã‚‚è¡¨ç¤º
  </label>
  <label>
    <input type="checkbox" id="showPast">
    éå»ã‚‚è¡¨ç¤º
  </label>
  <label>
    <input type="checkbox" id="sortByDate">
    æ—¥ä»˜é †ã«ä¸¦ã¹ã‚‹
  </label>
  <span id="now-display"></span>
</div>

<main>
  <div id="gatya"   class="content active"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="sale"    class="content"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="item"    class="content"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="mission" class="content"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
</main>

<script>
// =============================================
// çŠ¶æ…‹ç®¡ç†
// =============================================
let gatyaData  = [];
let saleData   = [];
let itemData   = [];
let saleNames  = new Map(); // id -> åå‰

let currentTab = 'gatya';

// =============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: æ—¥æ™‚ãƒ‘ãƒ¼ã‚¹
// ä¾‹: "20260216", "1100" â†’ Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
// =============================================
function parseDateTime(dateStr, timeStr) {
  const y   = parseInt(dateStr.slice(0, 4));
  const mon = parseInt(dateStr.slice(4, 6)) - 1;
  const d   = parseInt(dateStr.slice(6, 8));
  // "0", "000", "1100", "400" ãªã©ã‚’4æ¡ã«æ­£è¦åŒ–
  const t   = String(timeStr).padStart(4, '0');
  const h   = parseInt(t.slice(0, 2));
  const min = parseInt(t.slice(2, 4));
  return new Date(y, mon, d, h, min);
}

// =============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
// =============================================
function formatDate(date) {
  const y   = date.getFullYear();
  const mon = String(date.getMonth() + 1).padStart(2, '0');
  const d   = String(date.getDate()).padStart(2, '0');
  const h   = String(date.getHours()).padStart(2, '0');
  const min = String(date.getMinutes()).padStart(2, '0');
  return `${y}/${mon}/${d} ${h}:${min}`;
}

// =============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: CSV ãƒ‘ãƒ¼ã‚¹
// å½¢å¼: id,åå‰
// =============================================
function parseCSV(text) {
  const map = new Map();
  for (const line of text.split('\n')) {
    const idx = line.indexOf(',');
    if (idx === -1) continue;
    const id   = parseInt(line.slice(0, idx).trim());
    const name = line.slice(idx + 1).trim();
    if (!isNaN(id) && name) map.set(id, name);
  }
  return map;
}

// =============================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ— { start, end, ... } ã‚’å—ã‘å–ã‚Š
// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// =============================================
function filterAndSort(events) {
  const now         = new Date();
  const showCurrent = document.getElementById('showCurrent').checked;
  const showPast    = document.getElementById('showPast').checked;
  const sortByDate  = document.getElementById('sortByDate').checked;

  const filtered = events.filter(e => {
    const isPast    = e.end <= now;
    const isCurrent = e.start <= now && e.end > now;
    const isFuture  = e.start > now;

    if (showPast)    return true;             // ã™ã¹ã¦è¡¨ç¤º
    if (isPast)      return false;            // éå»ã¯éè¡¨ç¤º
    if (isCurrent)   return showCurrent;      // é–‹å‚¬ä¸­ã¯ãƒã‚§ãƒƒã‚¯æ¬¡ç¬¬
    if (isFuture)    return true;             // æœªæ¥ã¯å¸¸ã«è¡¨ç¤º
    return false;
  });

  if (sortByDate) {
    filtered.sort((a, b) => a.start - b.start);
  }

  return filtered;
}

// =============================================
// ã‚«ãƒ¼ãƒ‰ HTML ç”Ÿæˆ
// =============================================
function makeCard(name, message, start, end, isCurrent) {
  const tag = isCurrent
    ? '<span class="tag tag-current">é–‹å‚¬ä¸­</span>'
    : '<span class="tag tag-future">äºˆå®š</span>';

  const msgHtml = message
    ? `<div class="event-message">${message.replace(/<br\s*\/?>/gi, ' ')}</div>`
    : '';

  return `
    <div class="event-card ${isCurrent ? 'is-current' : ''}">
      <div class="card-header">
        ${tag}
        <div class="event-name">${name}</div>
      </div>
      ${msgHtml}
      <div class="event-dates">
        <span>é–‹å§‹: ${formatDate(start)}</span>
        <span>çµ‚äº†: ${formatDate(end)}</span>
      </div>
    </div>`;
}

// =============================================
// ã‚¬ãƒãƒ£ã‚¿ãƒ–æç”»
// gatya.json ã®å„ã‚¨ãƒ³ãƒˆãƒªã‚’å‡¦ç†
// gachas[].message ã‚’åå‰ã¨ã—ã¦ä½¿ç”¨
// =============================================
function renderGatya() {
  const now  = new Date();
  const cont = document.getElementById('gatya');

  // ã‚¨ãƒ³ãƒˆãƒªã”ã¨ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
  const events = gatyaData.map(entry => {
    const start = parseDateTime(entry.header.startDate, entry.header.startTime);
    const end   = parseDateTime(entry.header.endDate,   entry.header.endTime);

    // gachas ã® message ã‚’ã¾ã¨ã‚ã‚‹ (ç©ºã®ã‚‚ã®ã¯é™¤å¤–)
    const names = entry.gachas
      .map(g => g.message || '')
      .filter(Boolean);
    const name = names.length > 0 ? names.join('<br>') : `ã‚¬ãƒãƒ£ (ID: ${entry.gachas.map(g=>g.id).join(',')})`;

    return { start, end, name, message: '', entry };
  });

  const filtered = filterAndSort(events);

  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ã‚¬ãƒãƒ£ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  const cards = filtered.map(e => {
    const isCurrent = e.start <= now && e.end > now;
    return makeCard(e.name, e.message, e.start, e.end, isCurrent);
  }).join('');

  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + cards;
}

// =============================================
// ã‚»ãƒ¼ãƒ«(ã‚¤ãƒ™ãƒ³ãƒˆ)ã‚¿ãƒ–æç”»
// sale.json ã®å„ã‚¨ãƒ³ãƒˆãƒªã‚’å‡¦ç†
// stageIds[] ã‚’ sale_name.csv ã§åå‰ã«å¤‰æ›
// =============================================
function renderSale() {
  const now  = new Date();
  const cont = document.getElementById('sale');

  const events = saleData.map(entry => {
    const start = parseDateTime(entry.header.startDate, entry.header.startTime);
    const end   = parseDateTime(entry.header.endDate,   entry.header.endTime);

    // stageIds ã‚’åå‰ã«å¤‰æ›ã€ä¸æ˜ãªIDã¯ã€ŒID:xxxã€ã§è¡¨ç¤º
    const stageIds = entry.stageIds || [];
    const names    = stageIds.map(id => saleNames.get(id) ?? `ID:${id}`);
    const name     = names.join(', ');

    return { start, end, name, message: '', entry };
  });

  const filtered = filterAndSort(events);

  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  const cards = filtered.map(e => {
    const isCurrent = e.start <= now && e.end > now;
    return makeCard(e.name, e.message, e.start, e.end, isCurrent);
  }).join('');

  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + cards;
}

// =============================================
// ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ãƒ–æç”»
// item.json ã®å„ã‚¨ãƒ³ãƒˆãƒªã‚’å‡¦ç†
// gift.title ã¨ gift.message ã‚’ä½¿ç”¨
// =============================================
function renderItem() {
  const now  = new Date();
  const cont = document.getElementById('item');

  const events = itemData.map(entry => {
    const start   = parseDateTime(entry.header.startDate, entry.header.startTime);
    const end     = parseDateTime(entry.header.endDate,   entry.header.endTime);
    const gift    = entry.gift || {};
    const name    = gift.title    || `ã‚¤ãƒ™ãƒ³ãƒˆID: ${gift.eventId}`;
    const message = gift.message  || '';

    return { start, end, name, message, entry };
  });

  const filtered = filterAndSort(events);

  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  const cards = filtered.map(e => {
    const isCurrent = e.start <= now && e.end > now;
    return makeCard(e.name, e.message, e.start, e.end, isCurrent);
  }).join('');

  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + cards;
}

// =============================================
// ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¤å®š
// stageIds ã®ã„ãšã‚Œã‹ãŒå¯¾è±¡ãƒ¬ãƒ³ã‚¸ã«å«ã¾ã‚Œã‚‹ã‹
// å¯¾è±¡: 8000å°, 9000å°, 15000å°, 17000å°
// =============================================
function isMissionEntry(entry) {
  const ids = entry.stageIds || [];
  return ids.some(id =>
    (id >= 8000  && id <= 8999)  ||
    (id >= 9000  && id <= 9999)  ||
    (id >= 15000 && id <= 15999) ||
    (id >= 17000 && id <= 17999)
  );
}

// =============================================
// ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ãƒ–æç”»
// sale.json ã®ä¸­ã‹ã‚‰ãƒŸãƒƒã‚·ãƒ§ãƒ³å¯¾è±¡ã‚¨ãƒ³ãƒˆãƒªã‚’æŠ½å‡º
// =============================================
function renderMission() {
  const now  = new Date();
  const cont = document.getElementById('mission');

  // sale.json ã‹ã‚‰ãƒŸãƒƒã‚·ãƒ§ãƒ³å¯¾è±¡ã‚’æŠ½å‡º
  const events = saleData
    .filter(isMissionEntry)
    .map(entry => {
      const start    = parseDateTime(entry.header.startDate, entry.header.startTime);
      const end      = parseDateTime(entry.header.endDate,   entry.header.endTime);
      const stageIds = entry.stageIds || [];
      const names    = stageIds.map(id => saleNames.get(id) ?? `ID:${id}`);
      const name     = names.join(', ');
      return { start, end, name, message: '', entry };
    });

  const filtered = filterAndSort(events);

  if (filtered.length === 0) {
    cont.innerHTML = '<div class="empty">ğŸˆ è¡¨ç¤ºã™ã‚‹ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  const cards = filtered.map(e => {
    const isCurrent = e.start <= now && e.end > now;
    return makeCard(e.name, e.message, e.start, e.end, isCurrent);
  }).join('');

  cont.innerHTML = `<div class="count-label">${filtered.length} ä»¶</div>` + cards;
}

// =============================================
// å…¨ã‚¿ãƒ–å†æç”»
// =============================================
function renderAll() {
  renderGatya();
  renderSale();
  renderItem();
  renderMission();
}

// =============================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// =============================================
function showTab(tabName) {
  currentTab = tabName;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tabName);
  });
  document.querySelectorAll('.content').forEach(c => {
    c.classList.toggle('active', c.id === tabName);
  });
}

// =============================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// =============================================
async function loadData() {
  try {
    const BASE = 'https://kbc-rakv0.vercel.app/data';
    const [gatyaRes, saleRes, itemRes, saleNameRes] = await Promise.all([
      fetch(`${BASE}/gatya.json`),
      fetch(`${BASE}/sale.json`),
      fetch(`${BASE}/item.json`),
      fetch(`${BASE}/sale_name.csv`),
    ]);

    gatyaData = await gatyaRes.json();
    saleData  = await saleRes.json();
    itemData  = await itemRes.json();

    const saleNameText = await saleNameRes.text();
    saleNames = parseCSV(saleNameText);

    renderAll();
  } catch (err) {
    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    document.querySelectorAll('.loading').forEach(el => {
      el.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
    });
  }
}

// =============================================
// ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
// =============================================
function updateNow() {
  document.getElementById('now-display').textContent = 'ç¾åœ¨: ' + formatDate(new Date());
}

// =============================================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
// =============================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => showTab(tab.dataset.tab));
});

['showCurrent', 'showPast', 'sortByDate'].forEach(id => {
  document.getElementById(id).addEventListener('change', renderAll);
});

// åˆæœŸåŒ–
updateNow();
setInterval(updateNow, 60000); // 1åˆ†ã”ã¨ã«æ™‚åˆ»æ›´æ–°
loadData();
</script>
</body>
</html>
