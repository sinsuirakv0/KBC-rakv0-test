<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Gift Data TSV Parser</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    pre { background: #f0f0f0; padding: 1em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Gift Data TSV → JSON 変換</h1>
  <input type="file" id="fileInput" accept=".tsv,.txt"><br><br>
  <button id="parseBtn">解析してJSON出力</button>
  <pre id="output">ここに結果が表示されます</pre>

  <script>
    let rawText = '';

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        rawText = event.target.result;
      };
      reader.readAsText(file, 'utf-8');
    });

    document.getElementById('parseBtn').addEventListener('click', () => {
      if (!rawText) return;
      const lines = rawText.trim().split('\n').filter(line => line.trim() && line !== '[start]' && line !== '[end]');
      const results = lines.map(parseGiftLine);
      document.getElementById('output').textContent = JSON.stringify(results, null, 2);
    });

    function decodeWeekdays(bitmask) {
      if (bitmask === 0) return [];
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      return days.filter((_, i) => (bitmask >> i) & 1);
    }

    function parseGiftLine(line) {
      const parts = line.split('\t');
      const header = {
        startDate: parts[0],
        startTime: parts[1],
        endDate: parts[2],
        endTime: parts[3],
        minVersion: parts[4],
        maxVersion: parts[5]
      };

      let index = 6;
      index += 2; // skip two unused fields

      const timeBlocks = [];
      let timeBlockCount = parseInt(parts[index], 10);
      if (!isNaN(timeBlockCount) && timeBlockCount > 0) {
        index++;
        for (let i = 0; i < timeBlockCount; i++) {
          const block = {
            dateRanges: [],
            monthDays: [],
            weekdays: [],
            timeRanges: []
          };

          const yearCount = parseInt(parts[index++], 10);
          for (let j = 0; j < yearCount; j++) {
            const startDay = parts[index++];
            const startTime = parts[index++];
            const endDay = parts[index++];
            const endTime = parts[index++];
            block.dateRanges.push({ start: `${startDay} ${startTime}`, end: `${endDay} ${endTime}` });
          }

          const monthCount = parseInt(parts[index++], 10);
          for (let j = 0; j < monthCount; j++) {
            block.monthDays.push(parseInt(parts[index++], 10));
          }

          const weekdayBits = parseInt(parts[index++], 10);
          block.weekdays = decodeWeekdays(weekdayBits);

          const timeRangeCount = parseInt(parts[index++], 10);
          for (let j = 0; j < timeRangeCount; j++) {
            const start = parts[index++];
            const end = parts[index++];
            block.timeRanges.push([start, end]);
          }

          timeBlocks.push(block);
        }
      } else {
        timeBlockCount = 0;
        index++; // still need to skip the 0
      }

      const eventId = parseInt(parts[index++], 10);
      const giftType = parseInt(parts[index++], 10);
      const giftAmount = parseInt(parts[index++], 10);
      const title = parts[index++] || "";
      const messageOrUrl = parts[index++] || "";
      const isUrl = messageOrUrl.startsWith('http');
      const skip1 = parts[index++];
      const skip2 = parts[index++];
      const repeatFlag = parseInt(parts[index++] || "0", 10);

      return {
        header,
        timeBlocks,
        gift: {
          eventId,
          giftType,
          giftAmount,
          title,
          message: isUrl ? "" : messageOrUrl,
          url: isUrl ? messageOrUrl : "",
          repeatFlag
        }
      };
    }
  </script>
</body>
</html>

