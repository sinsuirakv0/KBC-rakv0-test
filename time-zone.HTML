<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KBC World Time</title>
  <style>
    :root {
      --bg:#0b1220; --card:#071427; --muted:#9fb0c8; --accent:#3b82f6;
      --glass: rgba(255,255,255,0.03); --text:#e6f0fb;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Noto Sans JP",sans-serif;
      background:linear-gradient(180deg,#051026 0%,#081428 60%);
      color:var(--text);
      padding:20px;
      display:flex;
      justify-content:center;
      animation: fadeIn 1s ease forwards;
      opacity:0;
    }

    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    .container{
      width:1100px; max-width:100%; display:grid; gap:16px;
    }
    .header{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);
      animation: fadeIn 1s ease 0.2s forwards; opacity:0;
    }
    .logo{ display:flex; align-items:center; gap:10px; }
    .logo img{ width:40px; height:40px; border-radius:8px; box-shadow:0 0 10px rgba(59,130,246,0.4); animation: floatLogo 3s ease-in-out infinite; }
    @keyframes floatLogo { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    h1{margin:0;font-size:22px;}
    .nav{display:flex;gap:20px;flex-wrap:wrap;}
    .nav a{color:var(--muted);text-decoration:none;font-size:14px;transition:0.2s;}
    .nav a:hover{color:var(--accent);}

    /* hero + small explanation (keeps UI same) */
    .hero{
      text-align:center; padding:18px 20px; background:var(--card); border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,0.6); animation: fadeIn 1s ease 0.4s forwards; opacity:0;
      display:flex; flex-direction:column; gap:8px;
    }
    .hero h2{ font-size:22px; margin:0; color:var(--accent); }
    .hero p{ color:var(--muted); font-size:13px; margin:0; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:16px;
      margin-top:6px;
    }
    .card{
      background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.6);
      transition:transform 0.3s, box-shadow 0.3s; opacity:0; animation: fadeIn 1s ease forwards;
      min-height:120px; display:flex; flex-direction:column; gap:8px;
    }
    .card h3{ margin:0; font-size:16px; color:var(--accent); display:flex; justify-content:space-between; align-items:center; }
    .big-time{ font-size:20px; margin-top:6px; color:var(--text); font-weight:700; }
    .small{ color:var(--muted); font-size:13px; }

    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .controls input[type="datetime-local"]{ background:var(--glass); border:1px solid rgba(255,255,255,0.05); color:var(--text); padding:8px 10px; border-radius:8px; font-size:13px; }
    .controls button{ background:linear-gradient(90deg,var(--accent),#60a5fa); border:none; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }

    .tz-list {
      margin-top:8px; max-height:360px; overflow:auto; border-radius:8px; border:1px solid rgba(255,255,255,0.03);
      padding:6px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));
    }
    .tz-row{ display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:6px; transition:background 0.12s; align-items:center; }
    .tz-row:hover{ background: rgba(255,255,255,0.02); cursor:pointer; }
    .tz-name{ font-size:14px; color:var(--text); }
    .tz-time{ font-size:13px; color:var(--muted); min-width:170px; text-align:right; }

    .card-tools { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .small-muted{ color:var(--muted); font-size:12px; }

    footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:30px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px; animation: fadeIn 1s ease 1.2s forwards; opacity:0; }

    @media (max-width:640px){ .controls{ flex-direction:column; align-items:center; } .tz-time{ min-width:120px; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- header (unchanged) -->
    <header class="header">
      <div class="logo">
        <img src="logo.png" alt="ãƒ­ã‚´">
        <h1>KBC</h1>
      </div>
      <nav class="nav">
        <a href="kbc-rakv0.vercel.app">ãƒ›ãƒ¼ãƒ </a>
        <a href="#">ä»®</a>
        <a href="#">ä»®</a>
        <a href="#">ä»®</a>
      </nav>
    </header>

    <!-- hero (added light explanation under title as requested) -->
    <section class="hero" aria-live="polite">
      <h2>KBC World Time</h2>
      <p>æ—¥æœ¬æ¨™æº–æ™‚ã‚’åŸºæº–ã«å„ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®æ™‚é–“ã‚’ç¢ºèªã§ãã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€ä¸‹ã®ä¸€è¦§ã‹ã‚‰é¸æŠã™ã‚‹ã¨å¤‰æ›´ã•ã‚Œã¾ã™ã€‚</p>
    </section>

    <!-- main grid: fixed 4 cards + dynamic changeable-cards container + tz list card -->
    <section class="grid" id="timeGrid">
      <!-- å›ºå®šã‚«ãƒ¼ãƒ‰ç¾¤ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
      <div class="card" id="card-jst">
        <h3>ç¾åœ¨æ™‚åˆ»ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ <span class="small-muted">Asia/Tokyo</span></h3>
        <div class="big-time" id="jst-time">--:--:--</div>
        <div class="small" id="jst-date">----</div>
      </div>

      <div class="card" id="card-samoa">
        <h3>ç±³é ˜ã‚µãƒ¢ã‚¢ <span class="small-muted">Pacific/Pago_Pago (UTCâˆ’11)</span></h3>
        <div class="big-time" id="samoa-time">--:--:--</div>
        <div class="small" id="samoa-date">----</div>
      </div>

      <div class="card" id="card-kiri">
        <h3>ã‚­ãƒªãƒã‚¹ <span class="small-muted">Pacific/Kiritimati (UTCï¼‹14)</span></h3>
        <div class="big-time" id="kiri-time">--:--:--</div>
        <div class="small" id="kiri-date">----</div>
      </div>

      <div class="card" id="card-kiri-plus">
        <h3>ã‚­ãƒªãƒã‚¹ +36æ™‚é–“ï¼ˆ41æ™‚é–“å¾Œï¼‰ <span class="small-muted">Pacific/Kiritimati</span></h3>
        <div class="big-time" id="kiri-plus-time">--:--:--</div>
        <div class="small" id="kiri-plus-date">----</div>
      </div>

      <!-- å¤‰æ›´å¯èƒ½ã‚«ãƒ¼ãƒ‰ç¾¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¢—ã‚„ã›ã‚‹ï¼‰ -->
      <div class="card" id="card-changeables">
        <h3>å¤‰æ›´å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ <span class="small-muted">ï¼ˆã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã€ä¸€è¦§ã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å‰²å½“ï¼‰</span></h3>

        <div id="changeablesContainer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
          <!-- å‹•çš„ã«ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ  -->
        </div>

        <div class="card-tools">
          <button id="addCard">ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
          <button id="resetToNow">ç¾åœ¨æ™‚åˆ»ã«æˆ»ã™</button>
          <div style="flex:1"></div>
          <div class="small-muted">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼š<span id="activeCardLabel">ãªã—</span></div>
        </div>

        <div class="controls" style="margin-top:8px;">
          <label style="font-size:13px;color:var(--muted);">åŸºæº–æ™‚åˆ»ã‚’æ‰‹å‹•ã§è¨­å®šï¼ˆJSTï¼‰:
            <input id="manualDatetime" type="datetime-local" style="margin-left:6px;">
          </label>
          <button id="applyManual">é©ç”¨</button>
        </div>
      </div>

      <!-- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸€è¦§ã‚«ãƒ¼ãƒ‰ -->
      <div class="card" id="card-list">
        <h3>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸€è¦§ï¼ˆå…¨ä»¶ï¼‰ <span class="small-muted">æ¤œç´¢ãƒ»ã‚¯ãƒªãƒƒã‚¯ã§å‰²å½“</span></h3>

        <div class="controls" style="margin-top:6px;">
          <input id="tzSearch" placeholder="æ¤œç´¢ï¼ˆä¾‹: Tokyo, America, Europeï¼‰" style="flex:1;padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--text)"/>
          <button id="reloadTz">å†èª­ã¿è¾¼ã¿</button>
        </div>

        <div class="tz-list" id="tzList" style="margin-top:8px;">
          <div style="color:var(--muted);font-size:13px;padding:6px 4px;">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>

      </div>
    </section>

    <footer>Â© KBC World Time Viewer</footer>
  </div>

<script>
(function(){
  const JST_TZ = 'Asia/Tokyo';
  const SAMOA_TZ = 'Pacific/Pago_Pago';
  const KIRITIMATI_TZ = 'Pacific/Kiritimati';

// ğŸŒ ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’UTCé †ã«ä¸¦ã¹ãŸãƒªã‚¹ãƒˆï¼ˆä¸»è¦éƒ½å¸‚ãƒ»åœ°åŸŸä»˜ããƒ»æ—¥æœ¬èªå¯¾å¿œï¼‰
const OFFSET_MAP = [
  [-12, "ã‚¢ãƒ¡ãƒªã‚«é ˜ã‚µãƒ¢ã‚¢ï¼ˆPacific/Pago_Pagoï¼‰"],
  [-11, "ãƒŸãƒƒãƒ‰ã‚¦ã‚§ãƒ¼è«¸å³¶ï¼ˆPacific/Midwayï¼‰"],
  [-10, "ãƒãƒ¯ã‚¤ï¼ˆPacific/Honoluluï¼‰"],
  [-9, "ã‚¢ãƒ©ã‚¹ã‚«ï¼ˆAmerica/Anchorageï¼‰"],
  [-8, "ãƒ­ã‚µãƒ³ã‚¼ãƒ«ã‚¹ï¼ˆAmerica/Los_Angelesï¼‰"],
  [-7, "ãƒ‡ãƒ³ãƒãƒ¼ï¼ˆAmerica/Denverï¼‰"],
  [-6, "ã‚·ã‚«ã‚´ï¼ˆAmerica/Chicagoï¼‰"],
  [-5, "ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ï¼ˆAmerica/New_Yorkï¼‰"],
  [-4, "ã‚µãƒ³ãƒ†ã‚£ã‚¢ã‚´ï¼ˆAmerica/Santiagoï¼‰"],
  [-3, "ãƒ–ã‚¨ãƒã‚¹ã‚¢ã‚¤ãƒ¬ã‚¹ï¼ˆAmerica/Argentina/Buenos_Airesï¼‰"],
  [-2, "å—ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢ï¼ˆAtlantic/South_Georgiaï¼‰"],
  [-1, "ã‚¢ã‚¾ãƒ¬ã‚¹è«¸å³¶ï¼ˆAtlantic/Azoresï¼‰"],
  [0, "ãƒ­ãƒ³ãƒ‰ãƒ³ï¼ˆEurope/Londonï¼‰"],
  [1, "ãƒ™ãƒ«ãƒªãƒ³ï¼ˆEurope/Berlinï¼‰"],
  [2, "ã‚«ã‚¤ãƒ­ï¼ˆAfrica/Cairoï¼‰"],
  [3, "ãƒ¢ã‚¹ã‚¯ãƒ¯ï¼ˆEurope/Moscowï¼‰"],
  [3.5, "ãƒ†ãƒ˜ãƒ©ãƒ³ï¼ˆAsia/Tehranï¼‰"],
  [4, "ãƒ‰ãƒã‚¤ï¼ˆAsia/Dubaiï¼‰"],
  [4.5, "ã‚«ãƒ–ãƒ¼ãƒ«ï¼ˆAsia/Kabulï¼‰"],
  [5, "ã‚«ãƒ©ãƒï¼ˆAsia/Karachiï¼‰"],
  [5.5, "ã‚¤ãƒ³ãƒ‰ï¼ã‚¹ãƒªãƒ©ãƒ³ã‚«ï¼ˆAsia/Kolkataï¼‰"],
  [5.75, "ã‚«ãƒˆãƒãƒ³ã‚ºï¼ˆAsia/Kathmanduï¼‰"],
  [6, "ãƒ€ãƒƒã‚«ï¼ˆAsia/Dhakaï¼‰"],
  [6.5, "ãƒ¤ãƒ³ã‚´ãƒ³ï¼ˆAsia/Yangonï¼‰"],
  [7, "ãƒãƒ³ã‚³ã‚¯ï¼ˆAsia/Bangkokï¼‰"],
  [8, "åŒ—äº¬ï¼ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ï¼ˆAsia/Shanghaiï¼‰"],
  [9, "æ±äº¬ï¼ˆAsia/Tokyoï¼‰"],
  [9.5, "ã‚¢ãƒ‡ãƒ¬ãƒ¼ãƒ‰ï¼ˆAustralia/Adelaideï¼‰"],
  [10, "ã‚·ãƒ‰ãƒ‹ãƒ¼ï¼ˆAustralia/Sydneyï¼‰"],
  [11, "ã‚½ãƒ­ãƒ¢ãƒ³è«¸å³¶ï¼ˆPacific/Guadalcanalï¼‰"],
  [12, "ãƒ•ã‚£ã‚¸ãƒ¼ï¼ˆPacific/Fijiï¼‰"],
  [13, "ãƒˆãƒ³ã‚¬ï¼ˆPacific/Tongatapuï¼‰"],
  [14, "ã‚­ãƒªãƒã‚¹ï¼ˆPacific/Kiritimatiï¼‰"]
];

  let serverBaseDate = null;
  let baseTimestamp = Date.now();

  const jstTimeEl = document.getElementById('jst-time');
  const jstDateEl = document.getElementById('jst-date');
  const samoaTimeEl = document.getElementById('samoa-time');
  const samoaDateEl = document.getElementById('samoa-date');
  const kiriTimeEl = document.getElementById('kiri-time');
  const kiriDateEl = document.getElementById('kiri-date');
  const kiriPlusTimeEl = document.getElementById('kiri-plus-time');
  const kiriPlusDateEl = document.getElementById('kiri-plus-date');

  const addCardBtn = document.getElementById('addCard');
  const changeablesContainer = document.getElementById('changeablesContainer');
  const activeCardLabel = document.getElementById('activeCardLabel');
  const manualDatetime = document.getElementById('manualDatetime');
  const applyManualBtn = document.getElementById('applyManual');
  const resetToNowBtn = document.getElementById('resetToNow');
  const tzListEl = document.getElementById('tzList');
  const tzSearch = document.getElementById('tzSearch');

  let changeableCards = [];
  let activeCardId = null;

  // ---- ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½ ----
  function saveState(){
    const data = {
      cards: changeableCards.map(c=>({id:c.id,tz:c.tz,label:c.label})),
      active: activeCardId
    };
    localStorage.setItem('worldtime_state', JSON.stringify(data));
  }

  function loadState(){
    const raw = localStorage.getItem('worldtime_state');
    if(!raw) return;
    try {
      const data = JSON.parse(raw);
      if(data.cards && Array.isArray(data.cards)){
        data.cards.forEach(c=>{
          createChangeableCard(c.tz,c.label,c.id);
        });
      }
      if(data.active) setActiveCard(data.active);
    } catch(e){ console.warn('loadState error', e); }
  }

  // ---- å…±é€šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ----
  function formatByTZ(dateObj, timeZone) {
    try {
      const fmt = new Intl.DateTimeFormat('ja-JP', {
        year:'numeric',month:'2-digit',day:'2-digit',
        hour:'2-digit',minute:'2-digit',second:'2-digit',
        hour12:false,timeZone
      });
      const p = {}; fmt.formatToParts(dateObj).forEach(x=>p[x.type]=x.value);
      return {date:`${p.year}/${p.month}/${p.day}`, time:`${p.hour}:${p.minute}:${p.second}`};
    } catch { return {date:'N/A', time:'N/A'}; }
  }

  function getVirtualNow(){
    if(!serverBaseDate) return new Date();
    const elapsed = Date.now() - baseTimestamp;
    return new Date(serverBaseDate.getTime() + elapsed);
  }

  async function syncServerTime(){
    try {
      const res = await fetch(`https://worldtimeapi.org/api/timezone/${JST_TZ}`,{mode:'cors'});
      if(!res.ok) throw 0;
      const data = await res.json();
      serverBaseDate = new Date(data.datetime);
    } catch {
      serverBaseDate = new Date();
    }
    baseTimestamp = Date.now();
    manualDatetime.value = toDatetimeLocalValue(serverBaseDate);
  }

  function toDatetimeLocalValue(date){
    const fmt = new Intl.DateTimeFormat('sv',{timeZone:JST_TZ,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    return fmt.format(date).replace(' ','T');
  }

function renderFixedCards(){
  const now = getVirtualNow();

  // ç¾åœ¨æ™‚åˆ» (JST)
  const jst = formatByTZ(now, JST_TZ);
  jstTimeEl.textContent = jst.time;
  jstDateEl.textContent = `${jst.date} (Asia/Tokyo)`;

  // ç±³é ˜ã‚µãƒ¢ã‚¢
  const sam = formatByTZ(now, SAMOA_TZ);
  samoaTimeEl.textContent = sam.time;
  samoaDateEl.textContent = sam.date;

  // ã‚­ãƒªãƒã‚¹ (Kiritimati)
  const k = formatByTZ(now, KIRITIMATI_TZ);
  kiriTimeEl.textContent = k.time;
  kiriDateEl.textContent = k.date;

  // ğŸ”¹ JSTåŸºæº–ã§36æ™‚é–“å¾Œã‚’æ±‚ã‚ã‚‹
  const jstNow = new Date(now.toLocaleString("en-US", { timeZone: JST_TZ }));
  const jstPlus36 = new Date(jstNow.getTime() + 36 * 60 * 60 * 1000);

  // ğŸ”¹ JST+36æ™‚é–“ã‚’ã‚­ãƒªãƒã‚¹æ™‚é–“ã§è¡¨ç¤º
  const kPlus = formatByTZ(jstPlus36, KIRITIMATI_TZ);
  kiriPlusTimeEl.textContent = kPlus.time;
  kiriPlusDateEl.textContent = `${kPlus.date} (JST +36h / Pacific/Kiritimati)`;
}

  // ---- ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ç®¡ç† ----
  function createChangeableCard(tz=JST_TZ,label='Asia/Tokyo',id){
    id = id || 'ch-' + Math.random().toString(36).slice(2,7);
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;">
        <div><span style="color:var(--accent);font-size:14px;">å¤‰æ›´å¯èƒ½ã‚«ãƒ¼ãƒ‰</span><br>
        <span class="small-muted">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: <span class="tz-label">${label}</span></span></div>
        <div><label style="font-size:12px;"><input type="radio" name="activeCardRadio"> é¸æŠ</label>
        <button class="removeCard" style="border:1px solid rgba(255,255,255,0.05);background:none;color:var(--muted);border-radius:6px;">å‰Šé™¤</button></div>
      </div>
      <div style="margin-top:6px;">
        <div class="big-time">--:--:--</div>
        <div class="small tz-date">----</div>
      </div>`;
    changeablesContainer.appendChild(el);
    const cardObj = {id,tz,label,el};
    changeableCards.push(cardObj);
    const radio = el.querySelector('input[type="radio"]');
    radio.addEventListener('change',()=>setActiveCard(id));
    el.querySelector('.removeCard').addEventListener('click',()=>removeChangeableCard(id));
    updateChangeableCardDisplay(cardObj);
    saveState();
    return cardObj;
  }

  function setActiveCard(id){
    activeCardId = id;
    const c = changeableCards.find(x=>x.id===id);
    activeCardLabel.textContent = c?c.label:'ãªã—';
    saveState();
  }

  function removeChangeableCard(id){
    const idx = changeableCards.findIndex(c=>c.id===id);
    if(idx>=0){ changeableCards[idx].el.remove(); changeableCards.splice(idx,1); }
    if(activeCardId===id){ activeCardId=null; activeCardLabel.textContent='ãªã—'; }
    saveState();
  }

  function updateChangeableCardDisplay(c){
    const now=getVirtualNow();
    const f=formatByTZ(now,c.tz);
    c.el.querySelector('.big-time').textContent=f.time;
    c.el.querySelector('.tz-date').textContent=f.date+' ('+c.tz+')';
    c.el.querySelector('.tz-label').textContent=c.tz;
  }

  function updateAllChangeables(){ changeableCards.forEach(updateChangeableCardDisplay); }

// ---------- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸€è¦§ï¼šãƒ–ãƒ©ã‚¦ã‚¶ï¼‹å›ºå®šãƒªã‚¹ãƒˆä¸¡å¯¾å¿œ ----------
async function renderTimezoneList() {
  tzListEl.innerHTML =
    '<div style="color:var(--muted);font-size:13px;padding:6px 4px;">ä¸€è¦§ã‚’ä½œæˆä¸­â€¦ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”Ÿæˆï¼‰</div>';

  const cacheKey = 'kbc_tz_all_v2';
  try {
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      const parsed = JSON.parse(cached);
      buildTzRowsFromArray(parsed);
      return;
    }
  } catch (e) {}

  let zones = [];
  if (typeof Intl === 'object' && typeof Intl.supportedValuesOf === 'function') {
    try {
      zones = Intl.supportedValuesOf('timeZone');
    } catch (e) {
      zones = [];
    }
  }

  // UTC -12 ï½ +14 ã‚’ç¶²ç¾…ï¼ˆä»®æƒ³å«ã‚€ï¼‰
  const FIXED_ZONES = [
    [-12, "Etc/GMT+12", "ãƒ™ãƒ¼ã‚«ãƒ¼å³¶ï¼ˆç±³é ˜ï¼‰"],
    [-11, "Pacific/Pago_Pago", "ç±³é ˜ã‚µãƒ¢ã‚¢"],
    [-10, "Pacific/Honolulu", "ãƒãƒ¯ã‚¤ï¼ˆç±³å›½ï¼‰"],
    [-9,  "America/Anchorage", "ã‚¢ãƒ©ã‚¹ã‚«ï¼ˆç±³å›½ï¼‰"],
    [-8,  "America/Los_Angeles", "ãƒ­ã‚µãƒ³ã‚¼ãƒ«ã‚¹ï¼ˆç±³å›½ï¼‰"],
    [-7,  "America/Denver", "ãƒ‡ãƒ³ãƒãƒ¼ï¼ˆç±³å›½ï¼‰"],
    [-6,  "America/Chicago", "ã‚·ã‚«ã‚´ï¼ˆç±³å›½ï¼‰"],
    [-5,  "America/New_York", "ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ï¼ˆç±³å›½ï¼‰"],
    [-4,  "America/Halifax", "ãƒãƒªãƒ•ã‚¡ãƒƒã‚¯ã‚¹ï¼ˆã‚«ãƒŠãƒ€ï¼‰"],
    [-3,  "America/Argentina/Buenos_Aires", "ãƒ–ã‚¨ãƒã‚¹ã‚¢ã‚¤ãƒ¬ã‚¹ï¼ˆã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³ï¼‰"],
    [-2,  "America/Noronha", "ãƒ•ã‚§ãƒ«ãƒŠãƒ³ãƒ‰ãƒ»ãƒ‡ãƒ»ãƒãƒ­ãƒ¼ãƒ‹ãƒ£ï¼ˆãƒ–ãƒ©ã‚¸ãƒ«ï¼‰"],
    [-1,  "Atlantic/Azores", "ã‚¢ã‚¾ãƒ¬ã‚¹è«¸å³¶ï¼ˆãƒãƒ«ãƒˆã‚¬ãƒ«ï¼‰"],
    [0,   "Europe/London", "ãƒ­ãƒ³ãƒ‰ãƒ³ï¼ˆã‚¤ã‚®ãƒªã‚¹ï¼‰"],
    [1,   "Europe/Paris", "ãƒ‘ãƒªï¼ˆãƒ•ãƒ©ãƒ³ã‚¹ï¼‰"],
    [2,   "Europe/Athens", "ã‚¢ãƒ†ãƒï¼ˆã‚®ãƒªã‚·ãƒ£ï¼‰"],
    [3,   "Europe/Moscow", "ãƒ¢ã‚¹ã‚¯ãƒ¯ï¼ˆãƒ­ã‚·ã‚¢ï¼‰"],
    [4,   "Asia/Dubai", "ãƒ‰ãƒã‚¤ï¼ˆUAEï¼‰"],
    [5,   "Asia/Karachi", "ã‚«ãƒ©ãƒï¼ˆãƒ‘ã‚­ã‚¹ã‚¿ãƒ³ï¼‰"],
    [5.5, "Asia/Kolkata", "ã‚³ãƒ«ã‚«ã‚¿ï¼ˆã‚¤ãƒ³ãƒ‰ï¼‰"],
    [6,   "Asia/Dhaka", "ãƒ€ãƒƒã‚«ï¼ˆãƒãƒ³ã‚°ãƒ©ãƒ‡ã‚·ãƒ¥ï¼‰"],
    [7,   "Asia/Bangkok", "ãƒãƒ³ã‚³ã‚¯ï¼ˆã‚¿ã‚¤ï¼‰"],
    [8,   "Asia/Shanghai", "ä¸Šæµ·ï¼ˆä¸­å›½ï¼‰"],
    [9,   "Asia/Tokyo", "æ±äº¬ï¼ˆæ—¥æœ¬ï¼‰"],
    [9.5, "Australia/Darwin", "ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³ï¼ˆè±ªå·ï¼‰"],
    [10,  "Australia/Sydney", "ã‚·ãƒ‰ãƒ‹ãƒ¼ï¼ˆè±ªå·ï¼‰"],
    [11,  "Pacific/Noumea", "ãƒŒãƒ¡ã‚¢ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¬ãƒ‰ãƒ‹ã‚¢ï¼‰"],
    [12,  "Pacific/Auckland", "ã‚ªãƒ¼ã‚¯ãƒ©ãƒ³ãƒ‰ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰ï¼‰"],
    [13,  "Pacific/Tongatapu", "ãƒˆãƒ³ã‚¬ï¼ˆãƒˆãƒ³ã‚¬ï¼‰"],
    [14,  "Pacific/Kiritimati", "ã‚­ãƒªãƒã‚¹ï¼ˆãƒ©ã‚¤ãƒ³è«¸å³¶ï¼‰"]
  ];

  const baseNow = getVirtualNow();

  function computeOffsetHoursForZone(nowDate, zone) {
    try {
      const fmt = new Intl.DateTimeFormat('en-CA', {
        timeZone: zone,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });
      const parts = fmt.formatToParts(nowDate);
      const p = {};
      parts.forEach(x => p[x.type] = x.value);
      const utcFromZone = Date.UTC(
        Number(p.year), Number(p.month) - 1, Number(p.day),
        Number(p.hour), Number(p.minute), Number(p.second)
      );
      const nowUtc = nowDate.getTime();
      const offsetMinutes = Math.round((utcFromZone - nowUtc) / 60000);
      return offsetMinutes / 60;
    } catch (e) {
      return null;
    }
  }

  const arr = [];

  // ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å–å¾—ã§ãã‚‹ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
  for (let i = 0; i < zones.length; i++) {
    const zone = zones[i];
    const offsetH = computeOffsetHoursForZone(baseNow, zone);
    if (offsetH === null || Number.isNaN(offsetH)) continue;
    arr.push({ offset: offsetH, zone, jpName: null });
  }

  // å›ºå®šã‚¾ãƒ¼ãƒ³ï¼ˆâˆ’12ã€œï¼‹14ï¼‰ã‚’å¿…ãšè¿½åŠ 
  FIXED_ZONES.forEach(([offset, zone, jpName]) => {
    if (!arr.some(a => a.zone === zone)) {
      arr.push({ offset, zone, jpName });
    }
  });

  arr.sort((a, b) => {
    if (a.offset !== b.offset) return a.offset - b.offset;
    return a.zone.localeCompare(b.zone);
  });

  try {
    localStorage.setItem(cacheKey, JSON.stringify(arr));
  } catch (e) {}

  buildTzRowsFromArray(arr);
}

// ---------- ãƒªã‚¹ãƒˆç”Ÿæˆ ----------
function buildTzRowsFromArray(arr) {
  tzListEl.innerHTML = '';
  arr.forEach(item => {
    const offset = item.offset;
    const zone = item.zone;
    const jpName = item.jpName;

    let displayName = jpName || zone.replace(/_/g, ' ').replace('/', ' / ');
    displayName = displayName
      .replace(/^Asia \//, 'ã‚¢ã‚¸ã‚¢ / ')
      .replace(/^Europe \//, 'ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ / ')
      .replace(/^America \//, 'ã‚¢ãƒ¡ãƒªã‚« / ')
      .replace(/^Pacific \//, 'å¤ªå¹³æ´‹ / ')
      .replace(/^Atlantic \//, 'å¤§è¥¿æ´‹ / ')
      .replace(/^Africa \//, 'ã‚¢ãƒ•ãƒªã‚« / ')
      .replace(/^Australia \//, 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢ / ')
      .replace(/^Indian \//, 'ã‚¤ãƒ³ãƒ‰æ´‹ / ')
      .replace(/^Antarctica \//, 'å—æ¥µ / ');

    const sign = offset >= 0 ? '+' : '';
    const hours = Math.trunc(Math.abs(offset));
    const frac = Math.abs(offset) - hours;
    const minutesPart = Math.round(frac * 60);
    const offsetStr =
      offset % 1 === 0
        ? `${sign}${offset}`
        : `${sign}${hours}:${String(minutesPart).padStart(2, '0')}`;

    const label = `UTC${offsetStr}ã€€${displayName}`;

    const row = document.createElement('div');
    row.className = 'tz-row';
    row.dataset.tz = zone;
    row.dataset.offset = offset;
    row.innerHTML = `<div class="tz-name">${label}</div><div class="tz-time">---</div>`;

    row.addEventListener('click', () => {
      if (activeCardId) {
        const card = changeableCards.find(c => c.id === activeCardId);
        if (card) {
          card.tz = zone;
          card.label = displayName;
          updateChangeableCardDisplay(card);
          saveState();
        }
      } else {
        navigator.clipboard?.writeText(zone).then(() => {
          row.querySelector('.tz-time').textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
          setTimeout(() => updateTzListTimes(), 800);
        });
      }
    });

    tzListEl.appendChild(row);
  });

  updateTzListTimes();
}

// ---------- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æ™‚é–“æ›´æ–° ----------
function updateTzListTimes() {
  const now = getVirtualNow();
  document.querySelectorAll('.tz-row').forEach(r => {
    const tz = r.dataset.tz;
    try {
      const f = formatByTZ(now, tz);
      r.querySelector('.tz-time').textContent = `${f.date} ${f.time}`;
    } catch (e) {
      r.querySelector('.tz-time').textContent = 'N/A';
    }
  });
}

// ---------- æ¤œç´¢ ----------
tzSearch.addEventListener('input', () => {
  const q = tzSearch.value.trim().toLowerCase();
  document.querySelectorAll('.tz-row').forEach(r => {
    const tz = (r.dataset.tz || '').toLowerCase();
    const name = (r.querySelector('.tz-name')?.textContent || '').toLowerCase();
    const offset = ('' + (r.dataset.offset ?? '')).toLowerCase();
    const ok = !q || tz.includes(q) || name.includes(q) || offset.includes(q);
    r.style.display = ok ? '' : 'none';
  });
});

  // ---- æ‰‹å‹•è¨­å®š ----
  applyManualBtn.addEventListener('click',()=>{
    if(!manualDatetime.value)return;
    const iso=manualDatetime.value+':00+09:00';
    serverBaseDate=new Date(iso);
    baseTimestamp=Date.now();
  });

  resetToNowBtn.addEventListener('click',syncServerTime);
  addCardBtn.addEventListener('click',()=>{createChangeableCard();saveState();});

  function renderAll(){
    renderFixedCards();
    updateAllChangeables();
    updateTzListTimes();
  }
  setInterval(renderAll,1000);

  (async function init(){
    await syncServerTime();
    loadState(); // â† è‡ªå‹•å¾©å…ƒ
    if(changeableCards.length===0) createChangeableCard();
    renderTimezoneList();
    renderAll();
  })();
})();
</script>
</body>
</html>