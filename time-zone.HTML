<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KBC World Time</title>
  <style>
    :root {
      --bg:#0b1220; --card:#071427; --muted:#9fb0c8; --accent:#3b82f6;
      --glass: rgba(255,255,255,0.03); --text:#e6f0fb;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Noto Sans JP",sans-serif;
      background:linear-gradient(180deg,#051026 0%,#081428 60%);
      color:var(--text);
      padding:20px;
      display:flex;
      justify-content:center;
      animation: fadeIn 1s ease forwards;
      opacity:0;
    }

    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    .container{
      width:1100px; max-width:100%; display:grid; gap:16px;
    }
    .header{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);
      animation: fadeIn 1s ease 0.2s forwards; opacity:0;
    }
    .logo{ display:flex; align-items:center; gap:10px; }
    .logo img{ width:40px; height:40px; border-radius:8px; box-shadow:0 0 10px rgba(59,130,246,0.4); animation: floatLogo 3s ease-in-out infinite; }
    @keyframes floatLogo { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    h1{margin:0;font-size:22px;}
    .nav{display:flex;gap:20px;flex-wrap:wrap;}
    .nav a{color:var(--muted);text-decoration:none;font-size:14px;transition:0.2s;}
    .nav a:hover{color:var(--accent);}

    /* hero + small explanation (keeps UI same) */
    .hero{
      text-align:center; padding:18px 20px; background:var(--card); border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,0.6); animation: fadeIn 1s ease 0.4s forwards; opacity:0;
      display:flex; flex-direction:column; gap:8px;
    }
    .hero h2{ font-size:22px; margin:0; color:var(--accent); }
    .hero p{ color:var(--muted); font-size:13px; margin:0; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:16px;
      margin-top:6px;
    }
    .card{
      background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.6);
      transition:transform 0.3s, box-shadow 0.3s; opacity:0; animation: fadeIn 1s ease forwards;
      min-height:120px; display:flex; flex-direction:column; gap:8px;
    }
    .card h3{ margin:0; font-size:16px; color:var(--accent); display:flex; justify-content:space-between; align-items:center; }
    .big-time{ font-size:20px; margin-top:6px; color:var(--text); font-weight:700; }
    .small{ color:var(--muted); font-size:13px; }

    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .controls input[type="datetime-local"]{ background:var(--glass); border:1px solid rgba(255,255,255,0.05); color:var(--text); padding:8px 10px; border-radius:8px; font-size:13px; }
    .controls button{ background:linear-gradient(90deg,var(--accent),#60a5fa); border:none; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }

    .tz-list {
      margin-top:8px; max-height:360px; overflow:auto; border-radius:8px; border:1px solid rgba(255,255,255,0.03);
      padding:6px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));
    }
    .tz-row{ display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:6px; transition:background 0.12s; align-items:center; }
    .tz-row:hover{ background: rgba(255,255,255,0.02); cursor:pointer; }
    .tz-name{ font-size:14px; color:var(--text); }
    .tz-time{ font-size:13px; color:var(--muted); min-width:170px; text-align:right; }

    .card-tools { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .small-muted{ color:var(--muted); font-size:12px; }

    footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:30px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px; animation: fadeIn 1s ease 1.2s forwards; opacity:0; }

    @media (max-width:640px){ .controls{ flex-direction:column; align-items:center; } .tz-time{ min-width:120px; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- header (unchanged) -->
    <header class="header">
      <div class="logo">
        <img src="logo.png" alt="ロゴ">
        <h1>KBC</h1>
      </div>
      <nav class="nav">
        <a href="#">  </a><a href="#"></a><a href="#"></a><a href="#"></a>
      </nav>
    </header>

    <!-- hero (added light explanation under title as requested) -->
    <section class="hero" aria-live="polite">
      <h2>KBC World Time</h2>
      <p>日本標準時を基準に各タイムゾーンの時間を確認できます。カードを選択し、下の一覧から選択すると変更されます。</p>
    </section>

    <!-- main grid: fixed 4 cards + dynamic changeable-cards container + tz list card -->
    <section class="grid" id="timeGrid">
      <!-- 固定カード群（常時表示） -->
      <div class="card" id="card-jst">
        <h3>現在時刻（日本時間） <span class="small-muted">Asia/Tokyo</span></h3>
        <div class="big-time" id="jst-time">--:--:--</div>
        <div class="small" id="jst-date">----</div>
      </div>

      <div class="card" id="card-samoa">
        <h3>米領サモア <span class="small-muted">Pacific/Pago_Pago (UTC−11)</span></h3>
        <div class="big-time" id="samoa-time">--:--:--</div>
        <div class="small" id="samoa-date">----</div>
      </div>

      <div class="card" id="card-kiri">
        <h3>キリバス <span class="small-muted">Pacific/Kiritimati (UTC＋14)</span></h3>
        <div class="big-time" id="kiri-time">--:--:--</div>
        <div class="small" id="kiri-date">----</div>
      </div>

      <div class="card" id="card-kiri-plus">
        <h3>キリバス +36時間（41時間後） <span class="small-muted">Pacific/Kiritimati</span></h3>
        <div class="big-time" id="kiri-plus-time">--:--:--</div>
        <div class="small" id="kiri-plus-date">----</div>
      </div>

      <!-- 変更可能カード群（ユーザーが増やせる） -->
      <div class="card" id="card-changeables">
        <h3>変更可能なカード <span class="small-muted">（カードを選んで、一覧からタイムゾーンを割当）</span></h3>

        <div id="changeablesContainer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
          <!-- 動的にカードを追加 -->
        </div>

        <div class="card-tools">
          <button id="addCard">カードを追加</button>
          <button id="resetToNow">現在時刻に戻す</button>
          <div style="flex:1"></div>
          <div class="small-muted">ターゲットカード：<span id="activeCardLabel">なし</span></div>
        </div>

        <div class="controls" style="margin-top:8px;">
          <label style="font-size:13px;color:var(--muted);">基準時刻を手動で設定（JST）:
            <input id="manualDatetime" type="datetime-local" style="margin-left:6px;">
          </label>
          <button id="applyManual">適用</button>
        </div>
      </div>

      <!-- タイムゾーン一覧カード -->
      <div class="card" id="card-list">
        <h3>タイムゾーン一覧（全件） <span class="small-muted">検索・クリックで割当</span></h3>

        <div class="controls" style="margin-top:6px;">
          <input id="tzSearch" placeholder="検索（例: Tokyo, America, Europe）" style="flex:1;padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--text)"/>
          <button id="reloadTz">再読み込み</button>
        </div>

        <div class="tz-list" id="tzList" style="margin-top:8px;">
          <div style="color:var(--muted);font-size:13px;padding:6px 4px;">読み込み中…</div>
        </div>

      </div>
    </section>

    <footer>© KBC World Time Viewer</footer>
  </div>

<script>
(function(){
  const JST_TZ = 'Asia/Tokyo';
  const SAMOA_TZ = 'Pacific/Pago_Pago';
  const KIRITIMATI_TZ = 'Pacific/Kiritimati';

  const OFFSET_MAP = [
    [-12,"Pacific/Pago_Pago"],[-11,"Pacific/Midway"],[-10,"Pacific/Honolulu"],
    [-9,"America/Anchorage"],[-8,"America/Los_Angeles"],[-7,"America/Denver"],
    [-6,"America/Chicago"],[-5,"America/New_York"],[-4,"America/Halifax"],
    [-3,"America/Sao_Paulo"],[-2,"Atlantic/South_Georgia"],[-1,"Atlantic/Azores"],
    [0,"Europe/London"],[1,"Europe/Paris"],[2,"Europe/Athens"],[3,"Europe/Moscow"],
    [4,"Asia/Dubai"],[5,"Asia/Karachi"],[6,"Asia/Dhaka"],[7,"Asia/Bangkok"],
    [8,"Asia/Singapore"],[9,"Asia/Tokyo"],[10,"Australia/Sydney"],
    [11,"Pacific/Noumea"],[12,"Pacific/Auckland"],[13,"Pacific/Tongatapu"],
    [14,"Pacific/Kiritimati"]
  ];

  let serverBaseDate = null;
  let baseTimestamp = Date.now();

  const jstTimeEl = document.getElementById('jst-time');
  const jstDateEl = document.getElementById('jst-date');
  const samoaTimeEl = document.getElementById('samoa-time');
  const samoaDateEl = document.getElementById('samoa-date');
  const kiriTimeEl = document.getElementById('kiri-time');
  const kiriDateEl = document.getElementById('kiri-date');
  const kiriPlusTimeEl = document.getElementById('kiri-plus-time');
  const kiriPlusDateEl = document.getElementById('kiri-plus-date');

  const addCardBtn = document.getElementById('addCard');
  const changeablesContainer = document.getElementById('changeablesContainer');
  const activeCardLabel = document.getElementById('activeCardLabel');
  const manualDatetime = document.getElementById('manualDatetime');
  const applyManualBtn = document.getElementById('applyManual');
  const resetToNowBtn = document.getElementById('resetToNow');
  const tzListEl = document.getElementById('tzList');
  const tzSearch = document.getElementById('tzSearch');

  let changeableCards = [];
  let activeCardId = null;

  // ---- 保存・復元機能 ----
  function saveState(){
    const data = {
      cards: changeableCards.map(c=>({id:c.id,tz:c.tz,label:c.label})),
      active: activeCardId
    };
    localStorage.setItem('worldtime_state', JSON.stringify(data));
  }

  function loadState(){
    const raw = localStorage.getItem('worldtime_state');
    if(!raw) return;
    try {
      const data = JSON.parse(raw);
      if(data.cards && Array.isArray(data.cards)){
        data.cards.forEach(c=>{
          createChangeableCard(c.tz,c.label,c.id);
        });
      }
      if(data.active) setActiveCard(data.active);
    } catch(e){ console.warn('loadState error', e); }
  }

  // ---- 共通フォーマット ----
  function formatByTZ(dateObj, timeZone) {
    try {
      const fmt = new Intl.DateTimeFormat('ja-JP', {
        year:'numeric',month:'2-digit',day:'2-digit',
        hour:'2-digit',minute:'2-digit',second:'2-digit',
        hour12:false,timeZone
      });
      const p = {}; fmt.formatToParts(dateObj).forEach(x=>p[x.type]=x.value);
      return {date:`${p.year}/${p.month}/${p.day}`, time:`${p.hour}:${p.minute}:${p.second}`};
    } catch { return {date:'N/A', time:'N/A'}; }
  }

  function getVirtualNow(){
    if(!serverBaseDate) return new Date();
    const elapsed = Date.now() - baseTimestamp;
    return new Date(serverBaseDate.getTime() + elapsed);
  }

  async function syncServerTime(){
    try {
      const res = await fetch(`https://worldtimeapi.org/api/timezone/${JST_TZ}`,{mode:'cors'});
      if(!res.ok) throw 0;
      const data = await res.json();
      serverBaseDate = new Date(data.datetime);
    } catch {
      serverBaseDate = new Date();
    }
    baseTimestamp = Date.now();
    manualDatetime.value = toDatetimeLocalValue(serverBaseDate);
  }

  function toDatetimeLocalValue(date){
    const fmt = new Intl.DateTimeFormat('sv',{timeZone:JST_TZ,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    return fmt.format(date).replace(' ','T');
  }

  function renderFixedCards(){
    const now = getVirtualNow();
    const jst = formatByTZ(now, JST_TZ);
    jstTimeEl.textContent = jst.time; jstDateEl.textContent = jst.date + ' (Asia/Tokyo)';
    const sam = formatByTZ(now, SAMOA_TZ);
    samoaTimeEl.textContent = sam.time; samoaDateEl.textContent = sam.date;
    const k = formatByTZ(now, KIRITIMATI_TZ);
    kiriTimeEl.textContent = k.time; kiriDateEl.textContent = k.date;
    const plus41 = new Date(now.getTime() + 41*3600*1000);
    const kp = formatByTZ(plus41, KIRITIMATI_TZ);
    kiriPlusTimeEl.textContent = kp.time; kiriPlusDateEl.textContent = kp.date;
  }

  // ---- カード生成・管理 ----
  function createChangeableCard(tz=JST_TZ,label='Asia/Tokyo',id){
    id = id || 'ch-' + Math.random().toString(36).slice(2,7);
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;">
        <div><span style="color:var(--accent);font-size:14px;">変更可能カード</span><br>
        <span class="small-muted">タイムゾーン: <span class="tz-label">${label}</span></span></div>
        <div><label style="font-size:12px;"><input type="radio" name="activeCardRadio"> 選択</label>
        <button class="removeCard" style="border:1px solid rgba(255,255,255,0.05);background:none;color:var(--muted);border-radius:6px;">削除</button></div>
      </div>
      <div style="margin-top:6px;">
        <div class="big-time">--:--:--</div>
        <div class="small tz-date">----</div>
      </div>`;
    changeablesContainer.appendChild(el);
    const cardObj = {id,tz,label,el};
    changeableCards.push(cardObj);
    const radio = el.querySelector('input[type="radio"]');
    radio.addEventListener('change',()=>setActiveCard(id));
    el.querySelector('.removeCard').addEventListener('click',()=>removeChangeableCard(id));
    updateChangeableCardDisplay(cardObj);
    saveState();
    return cardObj;
  }

  function setActiveCard(id){
    activeCardId = id;
    const c = changeableCards.find(x=>x.id===id);
    activeCardLabel.textContent = c?c.label:'なし';
    saveState();
  }

  function removeChangeableCard(id){
    const idx = changeableCards.findIndex(c=>c.id===id);
    if(idx>=0){ changeableCards[idx].el.remove(); changeableCards.splice(idx,1); }
    if(activeCardId===id){ activeCardId=null; activeCardLabel.textContent='なし'; }
    saveState();
  }

  function updateChangeableCardDisplay(c){
    const now=getVirtualNow();
    const f=formatByTZ(now,c.tz);
    c.el.querySelector('.big-time').textContent=f.time;
    c.el.querySelector('.tz-date').textContent=f.date+' ('+c.tz+')';
    c.el.querySelector('.tz-label').textContent=c.tz;
  }

  function updateAllChangeables(){ changeableCards.forEach(updateChangeableCardDisplay); }

  // ---- タイムゾーン一覧 ----
  function renderTimezoneList(){
    tzListEl.innerHTML='';
    OFFSET_MAP.forEach(([offset, zone])=>{
      const label=`UTC${offset>=0?'+':''}${offset} (${zone})`;
      const row=document.createElement('div');
      row.className='tz-row'; row.dataset.tz=zone; row.dataset.offset=offset;
      row.innerHTML=`<div class="tz-name">${label}</div><div class="tz-time">---</div>`;
      row.addEventListener('click',()=>{
        if(activeCardId){
          const card=changeableCards.find(c=>c.id===activeCardId);
          card.tz=zone; card.label=zone;
          updateChangeableCardDisplay(card);
          saveState(); // 状態を保持
        }
      });
      tzListEl.appendChild(row);
    });
    updateTzListTimes();
  }

  function updateTzListTimes(){
    const now=getVirtualNow();
    document.querySelectorAll('.tz-row').forEach(r=>{
      const tz=r.dataset.tz;
      const f=formatByTZ(now,tz);
      r.querySelector('.tz-time').textContent=f.date+' '+f.time;
    });
  }

  tzSearch.addEventListener('input',()=>{
    const q=tzSearch.value.toLowerCase();
    document.querySelectorAll('.tz-row').forEach(r=>{
      const match=r.dataset.tz.toLowerCase().includes(q) || r.dataset.offset.includes(q);
      r.style.display=match?'':'none';
    });
  });

  // ---- 手動設定 ----
  applyManualBtn.addEventListener('click',()=>{
    if(!manualDatetime.value)return;
    const iso=manualDatetime.value+':00+09:00';
    serverBaseDate=new Date(iso);
    baseTimestamp=Date.now();
  });

  resetToNowBtn.addEventListener('click',syncServerTime);
  addCardBtn.addEventListener('click',()=>{createChangeableCard();saveState();});

  function renderAll(){
    renderFixedCards();
    updateAllChangeables();
    updateTzListTimes();
  }
  setInterval(renderAll,1000);

  (async function init(){
    await syncServerTime();
    loadState(); // ← 自動復元
    if(changeableCards.length===0) createChangeableCard();
    renderTimezoneList();
    renderAll();
  })();
})();
</script>
</body>
</html>