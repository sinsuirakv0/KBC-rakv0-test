<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SAVE_DATA パーサー</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #f9f9f9;
    }
    input[type="file"] {
      margin-bottom: 1em;
    }
    pre {
      background: #eee;
      padding: 1em;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>SAVE_DATA 読み取りテスト</h1>
  <input type="file" id="fileInput" accept=".sav,.bin" />
  <pre id="output">ファイルを選択してください</pre>

  <script>
    function readInt(buffer, offset) {
      return buffer.getInt32(offset, true); // little-endian
    }

    function readString(buffer, offset) {
      const length = readInt(buffer, offset);
      const start = offset + 4;
      const end = start + length;
      const bytes = new Uint8Array(buffer.buffer, start, length);
      const value = new TextDecoder("utf-8").decode(bytes);
      return { value, nextOffset: end };
    }

    function parseSaveFile(arrayBuffer) {
      const buffer = new DataView(arrayBuffer);
      let offset = 0x2C0; // 仮の位置（必要に応じて調整）

      const { value: inquiryCode, nextOffset } = readString(buffer, offset);
      offset = nextOffset;

      const playTime = readInt(buffer, offset);
      offset += 4;

      const userRank = 9999; // 仮の固定値

      return { inquiryCode, playTime, userRank };
    }

    document.getElementById("fileInput").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const result = parseSaveFile(reader.result);
          document.getElementById("output").textContent = JSON.stringify(result, null, 2);
        } catch (e) {
          document.getElementById("output").textContent = "読み取りエラー: " + e.message;
        }
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
