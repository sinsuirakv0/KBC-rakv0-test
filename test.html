<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>inquiryCode 抽出テスト</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f9f9f9; }
    input[type="file"] { margin-bottom: 1em; }
    pre { background: #eee; padding: 1em; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>SAVE_DATA から inquiryCode を抽出</h1>
  <input type="file" id="fileInput" accept=".bin,.sav" />
  <pre id="output">ファイルを選択してください</pre>

  <script>
    function readInt(view, offset) {
      return view.getInt32(offset, true); // little-endian
    }

    function readString(view, offset) {
      const length = readInt(view, offset);
      const start = offset + 4;
      const end = start + length;
      const bytes = new Uint8Array(view.buffer, start, length);
      const value = new TextDecoder("utf-8").decode(bytes);
      return { value, nextOffset: end };
    }

    function findInquiryCode(arrayBuffer) {
      const view = new DataView(arrayBuffer);
      let offset = 0;

      // 1. transfer_code
      const s1 = readString(view, offset);
      offset = s1.nextOffset;

      // 2. confirmation_code
      const s2 = readString(view, offset);
      offset = s2.nextOffset;

      // 3. transfer_flag (1 byte)
      offset += 1;

      // 4. inquiryCode
      const s3 = readString(view, offset);
      return s3.value;
    }

    document.getElementById("fileInput").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const inquiryCode = findInquiryCode(reader.result);
          document.getElementById("output").textContent = `inquiryCode: ${inquiryCode}`;
        } catch (e) {
          document.getElementById("output").textContent = "読み取りエラー: " + e.message;
        }
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
