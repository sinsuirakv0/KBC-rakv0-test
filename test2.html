<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Level Data TSV Parser</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    pre { background: #f0f0f0; padding: 1em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Level Data TSV → JSON 変換</h1>
  <input type="file" id="fileInput" accept=".tsv,.txt"><br><br>
  <button id="parseBtn">解析してJSON出力</button>
  <pre id="output">ここに結果が表示されます</pre>

  <script>
    let rawText = '';

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        rawText = event.target.result;
      };
      reader.readAsText(file, 'utf-8');
    });

    document.getElementById('parseBtn').addEventListener('click', () => {
      if (!rawText) return;
      const lines = rawText.trim().split('\n').filter(line => line.trim() && line !== '[start]' && line !== '[end]');
      const results = lines.map(parseLevelLine);
      document.getElementById('output').textContent = JSON.stringify(results, null, 2);
    });

    function decodeWeekdays(bitmask) {
  if (bitmask === 0) return [];
  const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  return days.filter((_, i) => (bitmask >> i) & 1);
}

    function parseLevelLine(line) {
      const parts = line.trim().split('\t').filter(x => x !== '');
      const header = {
        startDate: parts[0],
        startTime: parts[1],
        endDate: parts[2],
        endTime: parts[3],
        minVersion: parts[4],
        maxVersion: parts[5]
      };

      let index = 6;
      index++; // skip unused flag
      const timeBlockCount = parseInt(parts[index++], 10);
      const timeBlocks = [];

      for (let i = 0; i < timeBlockCount; i++) {
        const block = {
          dateRanges: [],
          monthDays: [],
          weekdays: [],
          timeRanges: []
        };

        // Days of Year
        const yearCount = parseInt(parts[index++], 10);
        for (let j = 0; j < yearCount; j++) {
          const startDay = parts[index++];
          const startTime = parts[index++];
          const endDay = parts[index++];
          const endTime = parts[index++];
          block.dateRanges.push({ start: `${startDay} ${startTime}`, end: `${endDay} ${endTime}` });
        }

        // Days of Month
        const monthCount = parseInt(parts[index++], 10);
        for (let j = 0; j < monthCount; j++) {
          block.monthDays.push(parseInt(parts[index++], 10));
        }

        // Days of Week
        const weekdayBits = parseInt(parts[index++], 10);
        block.weekdays = decodeWeekdays(weekdayBits);

        // Times of Day
        const timeRangeCount = parseInt(parts[index++], 10);
        for (let j = 0; j < timeRangeCount; j++) {
          const start = parts[index++];
          const end = parts[index++];
          block.timeRanges.push([start, end]);
        }

        timeBlocks.push(block);
      }

      // ステージ数とステージID
      const stageCount = parseInt(parts[index++], 10);
      const stageIds = parts.slice(index, index + stageCount).map(Number);

      return {
        header,
        timeBlocks,
        stageIds
      };
    }
  </script>
</body>
</html>
