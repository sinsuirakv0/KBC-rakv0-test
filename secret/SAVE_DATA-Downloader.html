<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KBC SAVE_DATA Downloader</title>

  <link rel="stylesheet" href="../assets/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<link rel="icon" href="../assets/favicon.ico">
<meta property="og:title" content="KBC SAVE_DATADownloader">
<meta property="og:description" content="引継ぎコードから、セーブデータをダウンロードすることができます。バックアップにどうぞ。">
<meta property="og:image" content="../assets/preview.png">
<meta property="og:url" content="https://kbc-rakv0.vercel.app/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="KBC SAVE_DATADownloader">
<meta name="twitter:description" content="引継ぎコードから、セーブデータをダウンロードすることができます。バックアップにどうぞ。">
<meta name="twitter:image" content="../assets/preview.png">
  <!-- 共通スタイルを読み込む（先ほどの style.css を想定） -->
  <link rel="stylesheet" href="../assets/style.css">

  <style>
    /* ページ固有の軽い上書き（必要ならここで微調整） */
    .card { max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; margin-top: 28px; color: var(--text, #111); }
    /* 既存のインラインスタイルと競合しないように最小限に */
    #status { margin-top: 10px; }
  </style>
</head>
<body class="fade-in">

  <div class="container">
    <header class="header">
      <div class="header-left">
        <img src="../assets/logo.png" alt="Logo" id="logo">
        <h1 class="site-title">KBC</h1>
      </div>
      <nav class="nav">
        <a href="../index.html">Home</a>
        <a href="../secret/index.html">secret home</a>
      </nav>
    </header>
    
    <section class="card">
      <label>引継ぎコード (Transfer Code)</label>
      <input id="transferCode" type="text" placeholder=" " />

      <div class="row" style="margin-top:8px;">
        <div style="flex:1">
          <label>認証番号 (Confirmation Code)</label>
          <input id="pin" type="text" placeholder=" " />
        </div>
        <div style="flex:1">
          <label>国コード</label>
          <input id="countryCode" type="text" value="ja" />
        </div>
      </div>

      <label style="margin-top:8px">version</label>
      <input id="version" type="text" value="15.1.1" />

      <div class="form-actions" style="margin-top:12px;">
        <button id="downloadBtn">Download</button>
        <button id="clearBtn" class="secondary">Clear</button>
      </div>

      <div id="status" class="small"></div>
      <pre id="debug" style="display:none"></pre>
    </section>
  </div>

<script>
/* ユーティリティ: 安全な hex nonce を生成（16 バイト -> 32 hex） */
function generateNonceHex(bytes = 16) {
  const arr = new Uint8Array(bytes);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
}

/* version をパースして数値 (例: 150101) を返す */
function parseVersionInput(vRaw) {
  if (!vRaw && vRaw !== 0) return NaN;
  const s = String(vRaw).trim();
  if (/^\d{6}$/.test(s)) return Number(s);
  if (s.includes('.')) {
    const parts = s.split('.').map(p => p.trim());
    const major = parts[0] || '0';
    const minor = parts[1] || '0';
    const patch = parts[2] || '0';
    const pad2 = (n) => {
      const num = Number(n) || 0;
      if (num < 0) return '00';
      if (num > 99) return String(num).slice(-2);
      return String(num).padStart(2, '0');
    };
    const combined = `${String(Number(major)).padStart(2,'0')}${pad2(minor)}${pad2(patch)}`;
    return Number(combined);
  }
  if (/^\d+$/.test(s)) return Number(s);
  return NaN;
}

/* 入力を検証して正規化する */
function collectAndValidateInputs() {
  const transfer = (document.getElementById('transferCode').value || '').trim();
  const pin = (document.getElementById('pin').value || '').trim();
  const countryCode = (document.getElementById('countryCode').value || '').trim();
  const versionRaw = (document.getElementById('version').value || '').trim();

  const errors = [];
  if (!transfer) errors.push('Transfer Code を入力してください');
  if (!pin) errors.push('Pin を入力してください');
  if (!countryCode) errors.push('countryCode を入力してください');

  const parsedVersion = parseVersionInput(versionRaw);
  if (isNaN(parsedVersion)) errors.push('version を正しく入力してください（例: 15.1.1 または 15.0 または 150101）');

  if (errors.length) return { ok: false, errors };

  // nonce はユーザー入力させず、ここで自動生成
  const nonce = generateNonceHex(16);

  return {
    ok: true,
    data: { transfer, pin: String(pin), countryCode, version: parsedVersion, nonce }
  };
}

/* UI ヘルパー */
function setStatus(text, isError = false) {
  const s = document.getElementById('status');
  s.textContent = text;
  s.className = isError ? 'small error' : 'small';
  s.style.color = isError ? '#b00020' : '#0a6';
}

/* デバッグ表示ユーティリティ（append オプションあり） */
function setDebug(text, append = false) {
  const d = document.getElementById('debug');
  if (!d) return;
  if (append) d.textContent = (d.textContent || '') + text;
  else d.textContent = text || '';
  d.style.display = d.textContent ? 'block' : 'none';
}

/* ダウンロード処理（プロキシ経由） */
async function downloadViaProxy() {
  const btn = document.getElementById('downloadBtn');
  btn.disabled = true;

  try {
    setStatus('入力を検証中...');
    setDebug('', false);

    const collected = collectAndValidateInputs();
    if (!collected.ok) {
      setStatus(collected.errors.join(' / '), true);
      btn.disabled = false;
      return;
    }
    const { transfer, pin, countryCode, version, nonce } = collected.data;

    setStatus('リクエスト送信中...');
    const proxyUrl = '../api/proxy';

    const payload = {
      clientInfo: {
        client: { countryCode, version },
        device: { model: "SM-G955F" },
        os: { type: "android", version: "9" }
      },
      countryCode: countryCode,
      version: version,
      nonce,
      pin: String(pin),
      transfer
    };

    const controller = new AbortController();
    const timeoutMs = 30_000;
    const timeout = setTimeout(() => controller.abort(), timeoutMs);

    const res = await fetch(proxyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    clearTimeout(timeout);

    setDebug(`REQUEST PAYLOAD:\n${JSON.stringify(payload, null, 2)}\n\nRESPONSE STATUS: ${res.status} ${res.statusText}\nRESPONSE HEADERS:\n${[...res.headers.entries()].map(([k,v])=>`${k}: ${v}`).join('\n')}`, false);

    if (!res.ok) {
      const txt = await safeReadText(res);
      setStatus(`失敗: ${res.status} ${res.statusText}`, true);
      setDebug(`\n\nRESPONSE BODY:\n${txt}`, true);
      btn.disabled = false;
      return;
    }

    const contentType = (res.headers.get('content-type') || '').toLowerCase();
    if (!contentType.includes('application/octet-stream')) {
      const txt = await safeReadText(res);
      setStatus('レスポンスがバイナリではありません（エラー）', true);
      setDebug(`\n\nRESPONSE BODY:\n${txt}`, true);
      btn.disabled = false;
      return;
    }

    const blob = await res.blob();
    const filename = `downloaded_${transfer}.sav`;
    triggerDownload(blob, filename);
    setStatus(`ダウンロード完了: ${filename} (${blob.size} bytes)`);
  } catch (err) {
    if (err && err.name === 'AbortError') {
      setStatus('タイムアウトしました（ネットワークが遅い可能性があります）', true);
    } else {
      setStatus('リクエストエラー: ' + String(err), true);
    }
    setDebug(`\n\nERROR:\n${String(err)}`, true);
  } finally {
    btn.disabled = false;
  }
}

/* ヘルパー: レスポンスを安全にテキスト化 */
async function safeReadText(response) {
  try { return await response.text(); } catch (e) { return `<failed to read body: ${e}>`; }
}

/* ヘルパー: ブラウザでダウンロードをトリガー */
function triggerDownload(blob, filename) {
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

/* イベントバインド */
document.getElementById('downloadBtn').addEventListener('click', downloadViaProxy);
document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('transferCode').value = '';
  document.getElementById('pin').value = '';
  document.getElementById('version').value = '';
  setStatus('');
  setDebug('', false);
});
</script>
</body>
</html>
