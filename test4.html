<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>セールスケジュール</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    pre {
      background: #f9f9f9;
      padding: 1em;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>セールスケジュール</h1>
  <pre id="output">読み込み中...</pre>

  <script>
    const saleUrl = 'https://kbc-rakv0.vercel.app/data/sale.json'; // ← 実際のURLに置き換えてね
    const stageNameMap = {
      "1118": "ステージ名",
      // 他のステージIDもここに追加可能
    };

    function formatTime(t) {
      return `${t.slice(0, 2)}:${t.slice(2, 4)}`;
    }

    function formatDate(m, d) {
      return `${m.toString().padStart(2, '0')}/${d.toString().padStart(2, '0')}`;
    }

    function parseTimeBlocks(entry, stageName = "ステージ名") {
      const { startDate, startTime, endDate, endTime, minVersion, maxVersion } = entry.header;
      const baseYear = parseInt(startDate.slice(0, 4));
      const stageId = entry.stageIds[0]; // 単一想定

      const lines = [];
      lines.push(`[${stageId} ${stageName}]`);
      lines.push(`${startDate}(${startTime})-${endDate}(${endTime}) v:${minVersion}-${maxVersion}`);

      for (const block of entry.timeBlocks) {
        const { dateRanges, monthDays, weekdays, timeRanges } = block;

        // 時間帯の整形
        const timeStr = timeRanges.map(([s, e]) => `${formatTime(s)}～${formatTime(e)}`).join(', ');

        for (const range of dateRanges) {
          const [startMonth, startDay] = range.start.split(' ')[0].match(/(\d{1,2})(\d{2})/).slice(1).map(Number);
          const [endMonth, endDay] = range.end.split(' ')[0].match(/(\d{1,2})(\d{2})/).slice(1).map(Number);
          const startTime = formatTime(range.start.split(' ')[1]);
          const endTime = formatTime(range.end.split(' ')[1]);

          const dateStr = `${formatDate(startMonth, startDay)}(${startTime})～${formatDate(endMonth, endDay)}(${endTime})`;

          // AND条件チェック（dateRangesは必須、他は空なら無視）
          const hasMonthDays = monthDays.length > 0;
          const hasWeekdays = weekdays.length > 0;

          if (!hasMonthDays && !hasWeekdays) {
            lines.push(`・${dateStr} ${timeStr}`);
          } else {
            lines.push(`・${dateStr} ${timeStr} ※条件付き（未展開）`);
          }
        }
      }

      return lines.join('\n');
    }

    async function loadAndDisplay() {
      try {
        const res = await fetch(saleUrl);
        const data = await res.json();
        const output = document.getElementById('output');
        output.textContent = '';

        data.forEach(entry => {
          const stageId = entry.stageIds[0];
          const stageName = stageNameMap[stageId] || 'ステージ名不明';
          const text = parseTimeBlocks(entry, stageName);
          output.textContent += text + '\n\n';
        });
      } catch (err) {
        document.getElementById('output').textContent = '読み込みに失敗しました。';
        console.error(err);
      }
    }

    loadAndDisplay();
  </script>
</body>
</html>
