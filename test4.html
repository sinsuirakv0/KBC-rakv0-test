<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>セールスケジュール</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    .entry {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .entry:hover {
      background-color: #eef;
    }

    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .overlay-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80%;
      overflow-y: auto;
      white-space: pre-wrap;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1em;
      margin-bottom: 0;
      white-space: nowrap;
    }

    #overlay-title {
      font-weight: normal;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.1em;
      cursor: pointer;
    }

    pre {
      margin: 0;
    }
  </style>
</head>
<body>
  <h1>セールスケジュール</h1>
  <div id="list"></div>

  <div class="overlay" id="overlay">
    <div class="overlay-content" id="overlay-content">
      <div class="overlay-header">
        <span id="overlay-title">・ ステージ名</span>
        <button class="close-btn" onclick="hideOverlay()">×</button>
      </div>
      <pre id="overlay-body"></pre>
    </div>
  </div>

  <script>
    const saleUrl = 'https://kbc-rakv0.vercel.app/data/sale.json'; // ← 実際のURLに置き換えてね
    const stageNameMap = {
      "1014": "ステージ名A",
      "1118": "ステージ名B",
      "1421": "ステージ名C",
      "36020": "ネコ道場：激ムズ",
      "9493": "レジェンドステージ1",
      "9494": "レジェンドステージ2",
      "9495": "レジェンドステージ3",
      "9496": "レジェンドステージ4"
    };

    const weekdayMap = {
      "Sun": "日曜日",
      "Mon": "月曜日",
      "Tue": "火曜日",
      "Wed": "水曜日",
      "Thu": "木曜日",
      "Fri": "金曜日",
      "Sat": "土曜日"
    };

    function formatTime(t) {
      t = t.toString().padStart(4, '0');
      return `${t.slice(0, 2)}:${t.slice(2, 4)}`;
    }

    function formatDateWithWeekday(dateStr, timeStr) {
      const y = parseInt(dateStr.slice(0, 4));
      const m = parseInt(dateStr.slice(4, 6)) - 1;
      const d = parseInt(dateStr.slice(6, 8));
      const h = parseInt((timeStr || '0000').slice(0, 2));
      const min = parseInt((timeStr || '0000').slice(2, 4));
      const date = new Date(y, m, d, h, min);
      const weekday = "日月火水木金土"[date.getDay()];
      return `${y}/${(m+1).toString().padStart(2, '0')}/${d.toString().padStart(2, '0')}(${weekday}) ${formatTime(timeStr || '0000')}`;
    }

    function formatShortDate(md) {
      const m = md.month.toString().padStart(2, '0');
      const d = md.day.toString().padStart(2, '0');
      return `${m}/${d}`;
    }

    function parseTimeBlocks(entry, stageNames = []) {
      const { startDate, startTime, endDate, endTime, minVersion, maxVersion } = entry.header;
      const stageIds = entry.stageIds;

      const lines = [];
      lines.push(`期間：${formatDateWithWeekday(startDate, startTime)} ～ ${formatDateWithWeekday(endDate, endTime)}`);
      lines.push(`v:${minVersion}-${maxVersion} | id:${stageIds.join(', ')}`);

      const timeLines = [];

      for (const block of entry.timeBlocks) {
        const { dateRanges, monthDays, weekdays, timeRanges } = block;
        const timeStr = timeRanges.map(([s, e]) => `${formatTime(s)}～${formatTime(e)}`).join(' & ');

        if (dateRanges.length > 0) {
          for (const range of dateRanges) {
            const [sm, sd] = range.start.split(' ')[0].match(/(\d{1,2})(\d{2})/).slice(1).map(Number);
            const [em, ed] = range.end.split(' ')[0].match(/(\d{1,2})(\d{2})/).slice(1).map(Number);
            const st = formatTime(range.start.split(' ')[1]);
            const et = formatTime(range.end.split(' ')[1]);
            timeLines.push(`${sm.toString().padStart(2, '0')}/${sd.toString().padStart(2, '0')}(${st})～${em.toString().padStart(2, '0')}/${ed.toString().padStart(2, '0')}(${et}) ${timeStr}`);
          }
        } else if (monthDays.length > 0) {
          monthDays.forEach(day => {
            timeLines.push(`毎月${day}日 ${timeStr}`);
          });
        } else if (weekdays.length > 0) {
          weekdays.forEach(wd => {
            const jp = weekdayMap[wd] || wd;
            timeLines.push(`${jp} ${timeStr}`);
          });
        }
      }

      if (timeLines.length > 0) {
        lines.push('');
        lines.push(`開催日時：`);
        lines.push(...timeLines);
      }

      return {
        label: `${startDate.slice(4,6)}/${startDate.slice(6,8)}～${endDate.slice(4,6)}/${endDate.slice(6,8)}　${stageNames.join(', ')}`,
        detail: lines.join('\n').trim(),
        title: stageNames.join(', ')
      };
    }

    function showOverlay(title, text) {
      document.getElementById('overlay-title').textContent = `・ ${title}`;
      document.getElementById('overlay-body').textContent = text.trim();
      document.getElementById('overlay').style.display = 'flex';
    }

    function hideOverlay() {
      document.getElementById('overlay').style.display = 'none';
    }

    async function loadAndDisplay() {
      try {
        const res = await fetch(saleUrl);
        const data = await res.json();
        const list = document.getElementById('list');
        list.innerHTML = '';

        data.forEach(entry => {
          const stageNames = entry.stageIds.map(id => stageNameMap[id] || `ID:${id}`);
          const { label, detail, title } = parseTimeBlocks(entry, stageNames);

          const div = document.createElement('div');
          div.className = 'entry';
          div.textContent = label;
          div.addEventListener('click', () => showOverlay(title, detail));
          list.appendChild(div);
        });
      } catch (err) {
        document.getElementById('list').textContent = '読み込みに失敗しました。';
        console.error(err);
      }
    }

    loadAndDisplay();
  </script>
</body>
</html>
