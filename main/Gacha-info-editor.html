<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KBC Gacha Info Editor</title>
  <script src="js/ogp-loader.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ページ固有の調整 */
    textarea { width: 100%; min-height: 150px; font-family: monospace; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; margin-top: 10px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab { padding: 8px 15px; background: var(--glass); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--muted); }
    .tab.active { background: var(--accent); color: white; border-color: var(--accent); }
    .char-item { display: flex; gap: 8px; align-items: center; background: rgba(255,255,255,0.03); padding: 6px; border-radius: 6px; margin-bottom: 6px; }
    .output-box { background: #000; color: #a7f3d0; font-family: monospace; font-size: 12px; padding: 12px; border-radius: 8px; height: 200px; overflow-y: auto; border: 1px solid var(--border); white-space: pre-wrap; }
    .btn-mini { padding: 4px 10px; cursor: pointer; background: var(--glass); border: 1px solid var(--border); color: var(--text); border-radius: 4px; }
  </style>
</head>
<body class="fade-in">

  <div class="container">
    <header class="header">
      <div class="header-left">
        <img src="logo.png" alt="ロゴ" id="logo">
        <h1 class="site-title">KBC</h1>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
      </nav>
    </header>

    <section class="card">
      <h3>1. Gacha informatiomを貼り付け</h3>
      <p class="muted">Rare: 69.7%... などのデータを貼り付けると即座に反映されます</p>
      <textarea id="inputText" placeholder="ここに貼り付け..."></textarea>
      <div style="margin-top:10px; display:flex; gap:10px;">
        <button onclick="parseInput()" class="blue-input" style="background:var(--accent); color:white; border:none; cursor:pointer;">手動解析</button>
        <button onclick="clearAll()" class="blue-input" style="cursor:pointer;">クリア</button>
      </div>
    </section>

    <section class="card">
      <h3>2. gacha info作成/編集</h3>
      <div id="tabs" class="tabs"></div>
      
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap;">
        <div style="flex:1; min-width:300px;">
          <button onclick="addChar()" class="blue-input" style="margin-bottom:10px; cursor:pointer;">＋ キャラ追加</button>
          <div id="charList"></div>
        </div>
        
        <div style="width:250px; background:var(--glass); padding:15px; border-radius:10px; border:1px solid var(--border);">
          <label class="muted">単体レート(%)</label>
          <input type="number" id="ratePercent" class="blue-input" step="0.1" style="width:100%; margin-top:5px;" oninput="updateRatePreview()">
          <div class="muted" style="margin-top:10px;">内部レート: <span id="rateRaw" style="color:var(--accent); font-weight:bold;">0</span></div>
          <button onclick="saveRate()" class="blue-input" style="width:100%; margin-top:15px; background:var(--accent); color:white; border:none; cursor:pointer;">レートを保存</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
        <div>
          <div class="muted">Gacha information</div>
          <div id="outputGacha" class="output-box"></div>
          <button onclick="copyTxt('outputGacha')" class="blue-input" style="width:100%; margin-top:10px; cursor:pointer;">コピー</button>
        </div>
        <div>
          <div class="muted">レア度順まとめ</div>
          <div id="outputSummary" class="output-box"></div>
          <button onclick="copyTxt('outputSummary')" class="blue-input" style="width:100%; margin-top:10px; cursor:pointer;">コピー</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const rarities = ["Rare", "Super", "Uber", "Legendary"];
    let gacha = { Rare: [], Super: [], Uber: [], Legendary: [] };
    let rates = { Rare: 69.7, Super: 25.0, Uber: 5.0, Legendary: 0.3 };
    let currentRarity = "Rare";

    function parseInput() {
      const text = document.getElementById("inputText").value;
      if (!text.trim()) return;

      rarities.forEach(r => {
        const re = new RegExp(r + ":[\\s\\S]*?(?=(?:Rare|Super|Uber|Legendary|$))", "i");
        const m = text.match(re);
        if (!m) return;

        const block = m[0];
        const pMatch = block.match(/:\s*([0-9.]+)%/);
        if (pMatch) rates[r] = parseFloat(pMatch[1]);

        let listPart = "";
        if (block.includes(")")) {
          listPart = block.split(")").slice(1).join(")").trim();
        } else if (pMatch) {
          listPart = block.slice(block.indexOf(pMatch[0]) + pMatch[0].length).trim();
        }

        if (listPart) {
          gacha[r] = listPart.split(",")
            .map(s => s.replace(/^\s*\d+\s*[:\uFF1A]?\s*/, "").trim())
            .filter(s => s.length > 0);
        }
      });
      renderAll();
    }

    function renderAll() {
      const tabsDiv = document.getElementById("tabs");
      tabsDiv.innerHTML = "";
      rarities.forEach(r => {
        const el = document.createElement("div");
        el.className = "tab" + (r === currentRarity ? " active" : "");
        el.textContent = r;
        el.onclick = () => { currentRarity = r; renderAll(); };
        tabsDiv.appendChild(el);
      });

      const listDiv = document.getElementById("charList");
      listDiv.innerHTML = "";
      gacha[currentRarity].forEach((name, i) => {
        const row = document.createElement("div");
        row.className = "char-item";
        row.innerHTML = `
          <div style="width:25px; opacity:0.5; font-size:12px;">${i}</div>
          <input type="text" class="blue-input" value="${name}" style="flex:1; padding:4px;" oninput="gacha['${currentRarity}'][${i}]=this.value; updateOutputs();">
          <button class="btn-mini" onclick="moveChar(${i},-1)">↑</button>
          <button class="btn-mini" onclick="moveChar(${i},1)">↓</button>
          <button class="btn-mini" onclick="delChar(${i})" style="color:#ff4444">×</button>
        `;
        listDiv.appendChild(row);
      });

      document.getElementById("ratePercent").value = rates[currentRarity];
      updateRatePreview();
      updateOutputs();
    }

    function updateOutputs() {
      let gText = ""; let sText = "";
      rarities.forEach(r => {
        const arr = gacha[r];
        if (!arr || arr.length === 0) return;
        const pStr = rates[r].toFixed(1);
        gText += `${r}: ${pStr}% (${arr.length} cats) ${arr.map((n, i) => `${i} ${n}`).join(", ")}\n\n`;
        sText += `${r} (${pStr}%) rate:${Math.round(rates[r] * 100)}\n${arr.join("\n")}\n\n`;
      });
      document.getElementById("outputGacha").innerText = gText.trim();
      document.getElementById("outputSummary").innerText = sText.trim();
    }

    function updateRatePreview() {
      const v = parseFloat(document.getElementById("ratePercent").value) || 0;
      document.getElementById("rateRaw").textContent = Math.round(v * 100);
    }

    function saveRate() {
      rates[currentRarity] = parseFloat(document.getElementById("ratePercent").value) || 0;
      updateOutputs();
    }

    function addChar() { gacha[currentRarity].unshift("キャラ"); renderAll(); }
    function delChar(i) { gacha[currentRarity].splice(i,1); renderAll(); }
    function moveChar(i, dir) {
      const arr = gacha[currentRarity];
      if (i+dir >= 0 && i+dir < arr.length) {
        [arr[i], arr[i+dir]] = [arr[i+dir], arr[i]];
        renderAll();
      }
    }
    function clearAll() {
      document.getElementById("inputText").value = "";
      rarities.forEach(r => gacha[r] = []);
      renderAll();
    }
    function copyTxt(id) {
      navigator.clipboard.writeText(document.getElementById(id).innerText).then(() => alert("コピーしました"));
    }

    window.onload = () => {
      document.getElementById("inputText").oninput = parseInput;
      renderAll();
    };
  </script>
  <script src="secret.js"></script>
</body>
</html>

